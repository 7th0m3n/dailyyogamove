<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DailyYogaMove</title>
  <meta name="description" content="DailyYogaMove – Teachers, students, sequences, and breath pacing." />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      /* Colors */
      --bg-start: #0a0f1d;
      --bg-end: #0f1933;
      --radial: rgba(255,255,255,0.05);
      --card: #121a30;
      --card-2: #192448;
      --text: #ecf1ff;
      --muted: #b9c7e9;
      --accent-teal: #2dd4bf; /* teal */
      --accent-amber: #f59e0b; /* amber */
      --ring: rgba(45,212,191,0.45);
      --success: #22c55e;
      --warn: #f59e0b;
      --danger: #ef4444;
      --chip: #1f2a4a;
      --chip-pub: #0f3a2e;
      --chip-draft: #3a2f0f;

      /* Radii & Shadows */
      --radius: 22px;
      --radius-sm: 14px;
      --shadow-1: 0 12px 40px rgba(0,0,0,0.35);
      --shadow-2: 0 6px 18px rgba(0,0,0,0.25);

      /* Spacing */
      --space-12: 12px;
      --space-16: 16px;
      --space-24: 24px;
      --gap: var(--space-12);
      --gap-lg: var(--space-16);

      /* Motion */
      --transition: 180ms ease;

      /* Brand (teacher color) */
      --brand: #6ea8fe; /* dynamic per teacher */
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    html { scroll-behavior: smooth; }
    body {
      margin: 0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      line-height: 1.6;
      color: var(--text);
      background:
        radial-gradient(1200px 800px at 20% 0%, var(--radial), transparent 60%),
        radial-gradient(900px 700px at 90% 10%, rgba(45,212,191,0.08), transparent 60%),
        linear-gradient(160deg, var(--bg-start), var(--bg-end));
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    a { color: inherit; text-decoration: none; }
    button { font: inherit; color: inherit; background: none; border: none; cursor: pointer; }
    img { max-width: 100%; display: block; }

    .container {
      max-width: 1000px;
      margin: 0 auto;
      padding: 24px 16px 96px;
    }
    header[role="banner"] {
      position: sticky; top: 0; z-index: 10;
      background: linear-gradient(180deg, rgba(15,25,51,0.92), rgba(15,25,51,0.55) 60%, transparent);
      backdrop-filter: blur(10px);
    }
    .nav {
      display: flex; align-items: center; justify-content: space-between;
      gap: var(--gap);
      padding: 14px 16px;
    }
    .brand {
      display: inline-flex; align-items: center; gap: 10px; font-weight: 700;
    }
    .brand-badge {
      width: 28px; height: 28px; border-radius: 50%;
      background: conic-gradient(from 90deg, var(--brand), #9bd1ff);
      box-shadow: var(--shadow-2);
    }
    .nav-actions { display: flex; gap: 8px; }

    .btn {
      background: var(--brand);
      color: #0b1020;
      border-radius: 999px;
      padding: 10px 14px;
      font-weight: 600;
      box-shadow: var(--shadow-2);
      transition: transform var(--transition), box-shadow var(--transition), opacity var(--transition);
    }
    .btn:hover { transform: translateY(-1.5px); box-shadow: 0 8px 24px rgba(0,0,0,0.3); }
    .btn:focus-visible { outline: none; box-shadow: 0 0 0 3px var(--ring); }
    .btn.secondary { background: #25325d; color: var(--text); }
    .btn.ghost { background: transparent; border: 1px solid #2b3a72; color: var(--text); }
    .btn.danger { background: var(--danger); color: #0b1020; }
    .btn.warn { background: var(--warn); color: #0b1020; }
    .btn.success { background: var(--success); color: #08130a; }
    .btn.sm { padding: 6px 10px; font-weight: 600; }

    /* Nav active state */
    .nav-link.active { background: rgba(45,212,191,0.15); border: 1px solid rgba(45,212,191,0.35); color: var(--text); }

    .hero { margin: 28px 0 24px; text-align: center; }
    .hero h1 { font-family: "Playfair Display", Georgia, serif; font-size: clamp(28px, 6vw, 48px); letter-spacing: 0.2px; margin: 0 0 10px; }
    .hero p { color: var(--muted); margin: 0 0 16px; }

    .grid { display: grid; gap: var(--gap); }
    @media (min-width: 740px) { .grid.cols-2 { grid-template-columns: 1fr 1fr; } }

    .card {
      background: linear-gradient(180deg, var(--card), var(--card-2));
      border-radius: var(--radius);
      padding: 16px;
      box-shadow: var(--shadow-1);
      border: 1px solid rgba(255,255,255,0.07);
    }
    .card h3 { margin: 0 0 10px; font-size: 20px; font-family: "Playfair Display", Georgia, serif; letter-spacing: 0.2px; }
    .muted { color: var(--muted); }
    .row { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
    .space { height: 10px; }
    .spacer { flex: 1; }

    .input, select, textarea {
      width: 100%; background: #0f1835; border: 1px solid #2b3a72; color: var(--text);
      border-radius: 12px; padding: 10px 12px; outline: none; transition: box-shadow var(--transition), border var(--transition), transform var(--transition);
    }
    .input:focus, select:focus, textarea:focus { box-shadow: 0 0 0 3px var(--ring); border-color: var(--accent-teal); }
    label { display: block; font-size: 12px; color: var(--muted); margin-bottom: 6px; }

    .chip { display: inline-flex; align-items: center; gap: 6px; padding: 4px 8px; border-radius: 999px; background: var(--chip); color: #cfe3ff; font-weight: 600; font-size: 12px; }
    .chip.pub { background: var(--chip-pub); color: #bbf7d0; }
    .chip.draft { background: var(--chip-draft); color: #fde68a; }

    .list { display: grid; gap: 10px; }
    .seq-item { display: grid; grid-template-columns: 1fr auto; gap: 8px; align-items: center; padding: 12px; border: 1px solid #2b3a72; border-radius: 14px; background: #0f1835; }
    .seq-actions { display: flex; gap: 6px; }

    .tabs { display: flex; gap: 8px; border-bottom: 1px solid #27356b; margin-bottom: 12px; flex-wrap: wrap; }
    .tab { padding: 8px 10px; border-radius: 10px 10px 0 0; background: #0f1835; border: 1px solid #27356b; border-bottom: none; font-weight: 600; transition: transform var(--transition), box-shadow var(--transition); }
    .tab:hover { transform: translateY(-1px); box-shadow: var(--shadow-2); }
    .tab[aria-selected="true"] { background: #1a2553; color: #d6e6ff; border-color: rgba(45,212,191,0.25); }

    .tooltip { position: relative; }
    .tooltip[data-copied="true"]::after {
      content: "Copied";
      position: absolute; top: -28px; right: 0; background: #0f1835; color: #d6e6ff;
      border: 1px solid #2b3a72; padding: 4px 8px; border-radius: 8px; white-space: nowrap;
      box-shadow: var(--shadow-2);
    }

    .drag-handle { cursor: grab; user-select: none; padding: 6px 8px; border-radius: 8px; background: #0f1835; border: 1px dashed #2b3a72; }
    .pose-item { display: grid; grid-template-columns: auto 1fr; gap: 8px; align-items: start; background: #0f1835; border: 1px solid #2b3a72; border-radius: 10px; padding: 10px; }
    .pose-fields { display: grid; gap: 6px; }
    .pose-row { display: grid; grid-template-columns: 1fr 1fr 110px; gap: 8px; }
    .pose-tools { display: flex; gap: 6px; }

    .player { display: grid; gap: 10px; }
    .timer { font-variant-numeric: tabular-nums; font-size: 28px; font-weight: 700; }
    .breath-circle { width: 200px; height: 200px; border-radius: 50%; background: radial-gradient(circle at 30% 30%, #9bd1ff, var(--brand)); margin: 10px auto; transition: transform 4s ease-in-out; box-shadow: 0 0 0 8px rgba(110,168,254,0.2), 0 0 30px rgba(110,168,254,0.3) inset; }
    .small { font-size: 12px; color: var(--muted); }

    .sr-only { position: absolute; width: 1px; height: 1px; margin: -1px; padding: 0; overflow: hidden; clip: rect(0,0,0,0); border: 0; }

    /* Headings scale */
    h1 { font-family: "Playfair Display", Georgia, serif; font-size: clamp(28px, 6vw, 48px); line-height: 1.2; }
    h2 { font-family: "Playfair Display", Georgia, serif; font-size: clamp(24px, 4.5vw, 32px); line-height: 1.25; }
    h3 { font-family: "Playfair Display", Georgia, serif; font-size: 20px; line-height: 1.3; }

    /* Reduced motion */
    @media (prefers-reduced-motion: reduce) {
      * { transition: none !important; animation-duration: 0.01ms !important; animation-iteration-count: 1 !important; scroll-behavior: auto !important; }
      .breath-circle { transition: none; }
    }

    /* Mantras UI */
    .mantra-grid { display: grid; gap: 12px; grid-template-columns: 1fr; }
    @media (min-width: 740px) { .mantra-grid { grid-template-columns: 1fr 1fr; } }
    .mantra-card { background: linear-gradient(180deg, #0e1730, #121f44); border: 1px solid rgba(255,255,255,0.08); border-radius: 20px; padding: 14px; box-shadow: var(--shadow-2); display: grid; gap: 8px; }
    .mantra-card .devanagari { font-size: 28px; line-height: 1.2; }
    .mantra-card .translit { color: #c8d7ff; font-size: 14px; }
    .drawer { background: linear-gradient(180deg, var(--card), var(--card-2)); border: 1px solid rgba(255,255,255,0.08); border-radius: 18px; padding: 14px; box-shadow: var(--shadow-1); }
    .tag { display: inline-block; padding: 2px 8px; font-size: 12px; border-radius: 999px; border: 1px solid #2b3a72; color: #cfe3ff; margin: 0 6px 6px 0; cursor: pointer; }
    .tag.active { background: rgba(45,212,191,0.15); border-color: rgba(45,212,191,0.35); }

    /* Postures */
    .posture-filters { position: sticky; top: 64px; z-index: 5; background: linear-gradient(180deg, rgba(15,25,51,0.92), rgba(15,25,51,0.6)); padding: 8px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.06); backdrop-filter: blur(8px); }
    .posture-grid { display: grid; gap: 12px; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); }
    .posture-card { background: linear-gradient(180deg, #0e1730, #13214a); border: 1px solid rgba(255,255,255,0.08); border-radius: 18px; overflow: hidden; transition: box-shadow var(--transition), transform var(--transition), border-color var(--transition); }
    .posture-card:hover { transform: translateY(-2px); box-shadow: 0 12px 32px rgba(0,0,0,0.35); border-color: rgba(110,168,254,0.35); }
    .posture-media { height: 140px; background: radial-gradient(circle at 35% 35%, rgba(110,168,254,0.25), transparent 60%), linear-gradient(160deg, #0c1733, #15244d); display: grid; place-items: center; color: #9fc9ff; font-size: 32px; }
    .posture-body { padding: 12px; display: grid; gap: 6px; }
    .level { font-size: 11px; font-weight: 700; padding: 2px 8px; border-radius: 999px; }
    .level-beginner { background: rgba(34,197,94,0.18); color: #bbf7d0; border: 1px solid rgba(34,197,94,0.35); }
    .level-intermediate { background: rgba(245,158,11,0.18); color: #fde68a; border: 1px solid rgba(245,158,11,0.35); }
    .level-advanced { background: rgba(239,68,68,0.18); color: #fecaca; border: 1px solid rgba(239,68,68,0.35); }
    .modal { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; background: rgba(0,0,0,0.5); }
    .modal[open] { display: flex; }
    .modal-card { width: min(720px, 92vw); background: linear-gradient(180deg, var(--card), var(--card-2)); border: 1px solid rgba(255,255,255,0.08); border-radius: 20px; padding: 16px; box-shadow: var(--shadow-1); animation: fadeIn 200ms ease; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: translateY(0); } }
  </style>
</head>
<body>
  <header role="banner" aria-label="Top Navigation">
    <div class="nav container">
      <a class="brand" href="#/" aria-label="DailyYogaMove Home">
        <span class="brand-badge" aria-hidden="true"></span>
        <span>DailyYogaMove</span>
      </a>
      <nav class="nav-actions" aria-label="Primary">
        <a class="btn ghost nav-link" href="#/" role="button" aria-label="Home">Home</a>
        <a class="btn ghost nav-link" href="#/mantra-generator" role="button" aria-label="Mantra Generator">Mantra Generator</a>
        <a class="btn ghost nav-link" href="#/portal?tab=BreathPacer" role="button" aria-label="Breath Pacer">BreathPacer</a>
        <a class="btn nav-link" href="#/teacher" role="button" aria-label="Teacher Portal">Teacher</a>
      </nav>
    </div>
  </header>

  <main id="app" class="container" role="main" tabindex="-1"></main>

  <footer class="container" role="contentinfo">
    <div class="small">MVP prototype. Data saved locally. <!-- TODO: replace localStorage with Supabase (auth, RLS, tables) --></div>
  </footer>

  <!-- Toast -->
  <div id="toast" aria-live="polite" style="position:fixed; left:50%; bottom:18px; transform:translate(-50%,8px); background:#0f1835; border:1px solid #2b3a72; color:#d6e6ff; padding:8px 12px; border-radius:10px; box-shadow:0 8px 20px rgba(0,0,0,0.35); opacity:0; transition:opacity 180ms ease, transform 180ms ease; z-index:50;"></div>

  <script>
    // Store and App State Utilities
    const STORAGE_KEY = 'dym:store:v1';
    const SAVE_DEBOUNCE_MS = 300;
    let saveTimeout = null;
    // UI state
    let isPostureOpen = false;
    // Postures search index
    let POSE_INDEX = [];

    function nowIso() { return new Date().toISOString(); }
    function generateId(prefix = 'id') { return prefix + '_' + Math.random().toString(36).slice(2, 10); }
    function generateCode(length = 6) {
      const chars = 'ABCDEFGHJKMNPQRSTUVWXYZ23456789';
      let out = '';
      for (let i = 0; i < length; i++) out += chars[Math.floor(Math.random() * chars.length)];
      return out;
    }
    function copyToClipboard(text, el) {
      navigator.clipboard.writeText(text).then(() => {
        const host = el.closest('.tooltip');
        if (host) {
          host.dataset.copied = 'true';
          setTimeout(() => { delete host.dataset.copied; }, 1200);
        }
      });
    }

    // Text utils for Mantras
    function normalize(s){return (s||"").toLowerCase()
      .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
      .replace(/[^a-z0-9\s]/g,'').trim().replace(/\s+/g,' ');} // collapse spaces
    function slug(s){return normalize(s).replace(/\s+/g,'-');}
    function dedupeMantras(list){
      const seen=new Set(), out=[]; let removed = 0;
      for(const m0 of (list||[])){
        const m = upgradeMantraShape ? upgradeMantraShape(m0) : m0;
        const k=[normalize(m.title),normalize(m.devanagari),normalize(m.transliteration)].join('|');
        if(seen.has(k)){ removed++; continue; }
        seen.add(k); out.push(m);
      }
      out._removed = removed; // attach count for callers who care
      return out;
    }
    function makeUniqueId(baseId, teacher){
      let id = baseId; let i = 1;
      const ids = new Set((teacher?.mantras||[]).map(x => (upgradeMantraShape(x).id||'').toLowerCase()));
      while(ids.has(id.toLowerCase())) { id = baseId + '-' + (i++); }
      return id;
    }
    function showToast(message) {
      const el = document.getElementById('toast'); if (!el) return;
      el.textContent = message; el.style.opacity = '1'; el.style.transform = 'translateY(0)';
      clearTimeout(el._t); el._t = setTimeout(() => { el.style.opacity = '0'; el.style.transform = 'translateY(8px)'; }, 2200);
    }

    const Store = {
      load() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          if (!raw) return null;
          return JSON.parse(raw);
        } catch (e) { return null; }
      },
      save(newState) {
        if (saveTimeout) clearTimeout(saveTimeout);
        saveTimeout = setTimeout(() => {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(newState));
        }, SAVE_DEBOUNCE_MS);
      }
    };

    const App = {
      state: {
        teachers: {},
        currentTeacherId: null,
        activeTeacherId: null,
        demoTeacherId: null
      },
      get teacher() { return this.state.currentTeacherId ? this.state.teachers[this.state.currentTeacherId] : null; },
      get activeTeacher() { return this.state.activeTeacherId ? this.state.teachers[this.state.activeTeacherId] : null; },
      setTeacherColor(color) { document.documentElement.style.setProperty('--brand', color || '#6ea8fe'); }
    };

    // Mantras: global seed available for all teachers (unless teacher disables it)
    const GLOBAL_MANTRAS = [
      { id:"soham", title:"So’ham", devanagari:"सोऽहम्", transliteration:"So’ham", meaning:"I am That.", usage:"Sync with breath: So (inhale) — Ham (exhale).", recs:108, tags:["identity","calm"], status:"published" },
      { id:"om", title:"Om", devanagari:"ॐ", transliteration:"Oṃ", meaning:"Primordial sound.", usage:"Begin/end practice; single sustained tone.", recs:3, tags:["centering"], status:"published" },
      { id:"gayatri", title:"Gāyatrī", devanagari:"गायत्री मन्त्र", transliteration:"Om bhūr bhuvaḥ svaḥ…", meaning:"Illuminate the intellect.", usage:"Morning meditation; study focus.", recs:9, tags:["clarity","light"], status:"published" },
      { id:"mahamrityunjaya", title:"Mahāmṛtyuñjaya", devanagari:"महामृत्युंजय मन्त्र", transliteration:"Tryambakaṃ yajāmahe…", meaning:"Healing and resilience.", usage:"Recovery, courage under stress.", recs:27, tags:["healing","strength"], status:"published" },
      { id:"shanti", title:"Śāntiḥ Mantra", devanagari:"शान्तिः", transliteration:"Om śāntiḥ śāntiḥ śāntiḥ", meaning:"Peace in three realms.", usage:"Close classes; settle the room.", recs:3, tags:["peace"], status:"published" },
      { id:"lokah", title:"Lokāḥ Samastāḥ", devanagari:"लोकाः समस्ताः सुखिनो भवन्तु", transliteration:"Lokāḥ samastāḥ sukhino bhavantu", meaning:"May all beings be happy.", usage:"Service mindset; end of flow.", recs:9, tags:["compassion"], status:"published" },
      { id:"sohum-hamsa", title:"Haṃsa / So Hum", devanagari:"हंस / सो हम्", transliteration:"Haṃsa / So Hum", meaning:"Breath as mantra.", usage:"Match inhale/exhale silently all day.", recs:108, tags:["breath","mindfulness"], status:"published" },
      { id:"durga", title:"Durgā", devanagari:"दुर्गा मन्त्र", transliteration:"Om dum durgāyai namaḥ", meaning:"Protection and courage.", usage:"Before difficult tasks.", recs:21, tags:["protection","courage"], status:"published" },
      { id:"sarasvati", title:"Sarasvatī", devanagari:"सरस्वती मन्त्र", transliteration:"Om aim sarasvatyai namaḥ", meaning:"Learning and expression.", usage:"Teaching, study, writing.", recs:21, tags:["learning","voice"], status:"published" },
      { id:"ganesha", title:"Gaṇeśa", devanagari:"गणेश मन्त्र", transliteration:"Om gaṃ gaṇapataye namaḥ", meaning:"Remove obstacles.", usage:"New projects; before exams.", recs:21, tags:["beginnings"], status:"published" },
      { id:"shiva-mantra", title:"Śiva", devanagari:"शिव", transliteration:"Om namaḥ śivāya", meaning:"Inner stillness and transformation.", usage:"Deep practice; evening.", recs:108, tags:["stillness","purification"], status:"published" },
      { id:"navarna", title:"Navārṇa", devanagari:"नवार्ण मन्त्र", transliteration:"Om aiṃ hrīṃ klīṃ cāmuṇḍāyai vicce", meaning:"Cut through negativity.", usage:"When stuck; energy clearing.", recs:27, tags:["energy","clarity"], status:"published" }
    ];

    function kebabIdFromTitle(title) {
      const base = (title || '').toLowerCase().normalize('NFKD').replace(/[^\w\s'-]/g, '').replace(/[\s_]+/g, '-').replace(/-+/g, '-').replace(/^-|-$/g, '');
      return base || generateId('mantra');
    }

    function getAllMantrasForTeacher(teacher, publishedOnly = false) {
      const includeGlobal = teacher?.mantrasSettings?.includeGlobal !== false;
      const teacherMantras = (teacher?.mantras || []).map(m => upgradeMantraShape(m));
      const global = includeGlobal ? GLOBAL_MANTRAS : [];
      let combined = [...global, ...teacherMantras];
      if (publishedOnly) combined = combined.filter(m => (m.status || 'draft') === 'published');
      return combined;
    }

    function upgradeMantraShape(m) {
      // Back-compat: convert older shape {title,text,meaning,usage,recitations,published}
      if (!m) return m;
      const copy = { ...m };
      if (!copy.id) copy.id = kebabIdFromTitle(copy.title || copy.text || 'mantra');
      if (!copy.devanagari && copy.text) copy.devanagari = copy.text;
      if (typeof copy.recitations === 'number' && copy.recs == null) copy.recs = copy.recitations;
      if (copy.published != null && copy.status == null) copy.status = copy.published ? 'published' : 'draft';
      delete copy.recitations; delete copy.published; delete copy.text;
      return copy;
    }

    function ensureDemoSeed() {
      // Seed DEMO teacher if missing
      const existingDemo = Object.values(App.state.teachers).find(t => t.code === 'DEMO');
      if (existingDemo) { App.state.demoTeacherId = existingDemo.id; return; }
      const demoId = generateId('t');
      const demoSeqId = generateId('seq');
      const demoSeq2Id = generateId('seq');
      const demoProgramId = generateId('prog');
      let demoTeacher = {
        id: demoId,
        email: 'demo@dym.test',
        name: 'DEMO Studio',
        logoUrl: '',
        color: '#7dd3fc',
        welcome: 'Welcome to your practice. Explore, breathe, and move with presence.',
        code: 'DEMO',
        studioMode: false,
        subTeachers: [],
        modules: { breathpacer: true, pranayama: true, strengthasana: true, mantras: true },
        sequences: [
          {
            id: demoSeqId,
            title: 'Sunrise Flow',
            level: 'Beginner', tags: ['warmup','morning'], duration: 18,
            status: 'Published',
            poses: [
              { name: 'Tadasana', cues: 'Root feet. Lengthen spine. Relax jaw.', hold: 30 },
              { name: 'Uttanasana', cues: 'Fold from hips. Soften knees.', hold: 30 },
              { name: 'Adho Mukha Svanasana', cues: 'Hands press, sit bones up.', hold: 45 },
              { name: 'Bhujangasana', cues: 'Lift heart, shoulders soft.', hold: 30 }
            ],
            breathNotes: 'Inhale to lengthen, exhale to fold.',
            mediaUrl: ''
          },
          {
            id: demoSeq2Id,
            title: 'Core Ignite', level: 'Inter', tags: ['core','strength'], duration: 22,
            status: 'Draft',
            poses: [
              { name: 'Plank', cues: 'Heels back, crown forward.', hold: 45 },
              { name: 'Side Plank', cues: 'Lift hips, stack shoulders.', hold: 30 }
            ],
            breathNotes: 'Steady ujjayi throughout.', mediaUrl: ''
          }
        ],
        programs: [
          {
            id: demoProgramId,
            title: '2-Week Reset',
            description: 'Gentle re-entry with daily 20 minutes. Rest on Sundays.',
            schedule: [
              { day: 1, label: 'Mon - Sunrise Flow', sequenceId: demoSeqId },
              { day: 2, label: 'Tue - Breath + Flow', sequenceId: demoSeqId },
              { day: 3, label: 'Wed - Sunrise Flow', sequenceId: demoSeqId },
              { day: 4, label: 'Thu - Sunrise Flow', sequenceId: demoSeqId },
              { day: 5, label: 'Fri - Sunrise Flow', sequenceId: demoSeqId },
              { day: 6, label: 'Sat - Optional', sequenceId: null },
              { day: 7, label: 'Sun - Rest', sequenceId: null },
              { day: 8, label: 'Mon - Sunrise Flow', sequenceId: demoSeqId },
              { day: 9, label: 'Tue - Sunrise Flow', sequenceId: demoSeqId },
              { day: 10, label: 'Wed - Sunrise Flow', sequenceId: demoSeqId },
              { day: 11, label: 'Thu - Sunrise Flow', sequenceId: demoSeqId },
              { day: 12, label: 'Fri - Sunrise Flow', sequenceId: demoSeqId },
              { day: 13, label: 'Sat - Optional', sequenceId: null },
              { day: 14, label: 'Sun - Rest', sequenceId: null }
            ]
          }
        ],
        assignments: [],
        students: [],
        mantras: GLOBAL_MANTRAS.map(m => ({ ...m })),
        analytics: {
          portalVisits: [], // {studentCode, at}
          completions: [] // {studentCode, sequenceId, at}
        }
      };
      // De-duplicate global seed (should be unique already)
      const cleanedGlobal = dedupeMantras(GLOBAL_MANTRAS);
      // De-duplicate teacher overlay seed if any
      const cleanedOverlay = dedupeMantras(demoTeacher.mantras);
      const removed = (cleanedGlobal._removed||0) + (cleanedOverlay._removed||0);
      demoTeacher.mantras = cleanedOverlay;
      App.state.teachers[demoId] = demoTeacher;
      App.state.demoTeacherId = demoId;
      if (removed > 0) { App._dupesRemoved = (App._dupesRemoved||0) + removed; }
    }

    function init() {
      const saved = Store.load();
      if (saved) App.state = saved; else Store.save(App.state);
      ensureDemoSeed();
      // Clean duplicates in each teacher's mantras and write back if changed
      let totalRemoved = 0;
      Object.values(App.state.teachers).forEach(t => {
        if (!Array.isArray(t.mantras)) return;
        const cleaned = dedupeMantras(t.mantras);
        if (cleaned.length !== t.mantras.length) {
          t.mantras = cleaned; totalRemoved += (cleaned._removed||0) + (t.mantras.length - cleaned.length);
        }
      });
      if (totalRemoved > 0) { App._dupesRemoved = (App._dupesRemoved||0) + totalRemoved; persist(); }
      // Apply teacher theme color where relevant
      const t = App.teacher || App.activeTeacher || App.state.teachers[App.state.demoTeacherId];
      App.setTeacherColor(t?.color);
    }

    function persist() { Store.save(App.state); }

    // Router
    const AppRoot = document.getElementById('app');
    function parseHash() {
      const raw = location.hash || '#/';
      const [path, queryStr] = raw.split('?');
      const query = Object.fromEntries(new URLSearchParams(queryStr || ''));
      return { path, query };
    }
    function navigate(hash) {
      if (location.hash !== hash) location.hash = hash; else render();
    }
    window.addEventListener('hashchange', () => { render(); });

    function render() {
      const { path, query } = parseHash();
      // Smooth scroll to top
      window.scrollTo({ top: 0, behavior: 'smooth' });
      // Set active nav link
      document.querySelectorAll('.nav-link').forEach(a => {
        const href = a.getAttribute('href');
        const target = href.split('?')[0];
        const current = (location.hash || '#/').split('?')[0];
        const isActive = target === current || (target === '#/' && (current === '#/' || current === '#' || current === ''));
        a.classList.toggle('active', !!isActive);
      });
      switch (path) {
        case '#/':
        case '#':
        case '':
          return renderLanding();
        case '#/postures':
          return renderPostures();
        case '#/mantras':
          return renderTraditionalMantras();
        case '#/mantra-generator':
          return renderMantraGenerator();
        case '#/join':
          return renderJoin(query);
        case '#/teacher':
          return renderTeacherPortal();
        case '#/portal':
          return renderStudentPortal(query);
        default:
          navigate('#/');
      }
    }

    // UI Helpers
    function el(html) { const d = document.createElement('div'); d.innerHTML = html.trim(); return d.firstElementChild; }
    function setToolbarForTeacher(teacher) { App.setTeacherColor(teacher?.color); }
    function teacherByCode(code) {
      code = (code || '').trim().toUpperCase();
      // match teacher code
      let found = Object.values(App.state.teachers).find(t => (t.code || '').toUpperCase() === code);
      if (found) return found;
      // match sub-teacher code to parent studio
      for (const t of Object.values(App.state.teachers)) {
        if (Array.isArray(t.subTeachers) && t.subTeachers.find(st => (st.code || '').toUpperCase() === code)) {
          return t; // map sub-teacher code to parent studio theme/portal
        }
      }
      return null;
    }
    function shortTags(tags) {
      if (!tags || !tags.length) return '';
      return tags.map(t => `<span class="chip">${t}</span>`).join(' ');
    }
    function statusChip(status) { return `<span class="chip ${status==='Published'?'pub':'draft'}">${status}</span>`; }

    // Landing
    function renderLanding() {
      const demoCode = 'DEMO';
      AppRoot.innerHTML = `
        <section class="hero" aria-labelledby="hero-title">
          <h1 id="hero-title">Practice. Sequence. Teach.</h1>
          <p>Mobile-first yoga teaching and student portal with breath pacing.</p>
          <div class="row" role="group" aria-label="Primary Calls to Action" style="justify-content:center; gap:10px;">
            <a class="btn" href="#/join" role="button">Enter Teacher Code</a>
            <a class="btn secondary" href="#/teacher" role="button">I'm a Teacher</a>
            <button class="btn ghost" id="cta-demo" aria-label="Explore Demo">Explore Demo</button>
          </div>
        </section>

        <section class="grid cols-2" aria-label="Explore Demo">
          <div class="card">
            <h3>Students</h3>
            <div class="list">
              <div class="seq-item">
                <div>
                  <strong>Assigned Asana & Sequences</strong>
                  <div class="small">See programs assigned by your teacher.</div>
                </div>
                <div class="seq-actions">
                  <a class="btn sm" href="#/portal" aria-label="Open Student Portal">Open</a>
                </div>
              </div>
              <div class="seq-item">
                <div>
                  <strong>Traditional Mantras</strong>
                  <div class="small">Recite and study classical Sanskrit mantras.</div>
                </div>
                <div class="seq-actions">
                  <a class="btn sm" href="#/mantras" aria-label="Open Traditional Mantras">Open</a>
                </div>
              </div>
              <div class="seq-item">
                <div>
                  <strong>BreathPacer</strong>
                  <div class="small">Timed inhale/hold/exhale visual pacer.</div>
                </div>
                <div class="seq-actions">
                  <a class="btn sm" href="#/portal?tab=BreathPacer" aria-label="Open BreathPacer">Open</a>
                </div>
              </div>
            </div>
          </div>
          <div class="card">
            <h3>Teachers</h3>
            <div class="list">
              <div class="seq-item">
                <div>
                  <strong>Strengthāsana</strong>
                  <div class="small">Create and publish Signature Sequences.</div>
                </div>
                <div class="seq-actions">
                  <a class="btn sm" href="#/teacher" aria-label="Open Teacher Portal">Open</a>
                </div>
              </div>
              <div class="seq-item">
                <div>
                  <strong>Paripūrṇa Prāṇa</strong>
                  <div class="small">Pranayama tools and presets.</div>
                </div>
                <div class="seq-actions">
                  <a class="btn sm" href="#/portal?tab=Paripūrṇa Prāṇa" aria-label="Open Paripūrṇa Prāṇa">Open</a>
                </div>
              </div>
              <div class="seq-item">
                <div>
                  <strong>Complete Postures List</strong>
                  <div class="small">Browse and reference every asana in the DailyYogaMove library.</div>
                </div>
                <div class="seq-actions">
                  <button class="btn sm" id="open-postures" aria-label="Open Complete Postures List">Open</button>
                </div>
              </div>
              <div class="seq-item">
                <div>
                  <strong>Mantra Generator</strong>
                  <div class="small">Create, preview, and publish mantras.</div>
                </div>
                <div class="seq-actions">
                  <a class="btn sm" href="#/mantra-generator" aria-label="Open Mantra Generator">Open</a>
                </div>
              </div>
            </div>
          </div>
        </section>
      `;
      document.getElementById('cta-demo').addEventListener('click', () => {
        const demo = teacherByCode(demoCode);
        if (demo) { App.state.activeTeacherId = demo.id; persist(); navigate('#/portal'); }
      });
      const posturesBtn = document.getElementById('open-postures');
      if (posturesBtn) posturesBtn.addEventListener('click', () => {
        if (!App.state.currentTeacherId) { showToast('Teacher sign-in required.'); navigate('#/teacher'); return; }
        navigate('#/postures');
      });
      AppRoot.focus();
    }

    // Join
    function renderJoin(query) {
      const prefill = query.code || '';
      AppRoot.innerHTML = `
        <section class="grid" aria-labelledby="join-title">
          <div class="card">
            <h3 id="join-title">Join a Teacher's Portal</h3>
            <div class="space"></div>
            <label for="join-code">Teacher Code</label>
            <div class="row">
              <input id="join-code" class="input" inputmode="text" autocomplete="off" placeholder="e.g. DEMO" value="${prefill}" aria-describedby="join-help" />
              <button id="join-btn" class="btn" aria-label="Join">Join</button>
            </div>
            <div id="join-help" class="small">Tip: Use DEMO to explore.</div>
          </div>
        </section>
      `;
      const input = document.getElementById('join-code');
      const btn = document.getElementById('join-btn');
      function act() {
        const code = input.value.trim();
        const t = teacherByCode(code);
        if (!t) { input.setCustomValidity('Invalid code'); input.reportValidity(); return; }
        App.state.activeTeacherId = t.id;
        // track visit
        t.analytics.portalVisits.push({ studentCode: 'anon', at: nowIso() });
        persist();
        navigate('#/portal');
      }
      btn.addEventListener('click', act);
      input.addEventListener('keydown', (e) => { if (e.key === 'Enter') act(); });
      AppRoot.focus();
    }

    // Teacher Portal
    function renderTeacherPortal() {
      // Fake auth by email; store currentTeacherId
      const t = App.teacher;
      if (!t) {
        AppRoot.innerHTML = `
          <section class="card" aria-labelledby="auth-title">
            <h3 id="auth-title">Teacher Login</h3>
            <div class="space"></div>
            <label for="email">Email</label>
            <div class="row">
              <input id="email" class="input" type="email" placeholder="you@studio.com" aria-describedby="auth-note" />
              <button id="login" class="btn">Continue</button>
            </div>
            <div id="auth-note" class="small">No password required. <!-- TODO: replace fake auth with magic-link --></div>
          </section>
        `;
        document.getElementById('login').addEventListener('click', () => {
          const email = /** @type {HTMLInputElement} */(document.getElementById('email')).value.trim();
          if (!email) return;
          let teacher = Object.values(App.state.teachers).find(x => x.email === email);
          if (!teacher) {
            const id = generateId('t');
            const code = generateCode();
            teacher = {
              id, email, name: email.split('@')[0], logoUrl: '', color: '#6ea8fe', welcome: 'Welcome, set your studio profile.',
              code, studioMode: false, subTeachers: [], modules: { breathpacer: true, pranayama: true, strengthasana: true, mantras: true },
              sequences: [], programs: [], assignments: [], students: [], mantras: [], analytics: { portalVisits: [], completions: [] }
            };
            App.state.teachers[id] = teacher;
          }
          App.state.currentTeacherId = teacher.id; App.setTeacherColor(teacher.color); persist(); renderTeacherPortal();
        });
        AppRoot.focus();
        return;
      }

      setToolbarForTeacher(t);
      const totalStudents = t.students.length;
      const weekAgo = Date.now() - 7*24*60*60*1000;
      const activeThisWeek = t.analytics.portalVisits.filter(v => new Date(v.at).getTime() >= weekAgo).length;
      const assignedPrograms = t.assignments.length;

      AppRoot.innerHTML = `
        <section class="grid" aria-label="Teacher Portal">
          <div class="row" role="group" aria-label="Studio Stats">
            <div class="chip">Students: ${totalStudents}</div>
            <div class="chip">Active this week: ${activeThisWeek}</div>
            <div class="chip">Assignments: ${assignedPrograms}</div>
            <span class="spacer"></span>
            <button id="logout" class="btn ghost">Log out</button>
          </div>

          <div class="grid cols-2">
            <div class="card" aria-labelledby="profile-title">
              <h3 id="profile-title">Profile</h3>
              <div class="grid">
                <div>
                  <label for="name">Studio/Name</label>
                  <input id="name" class="input" value="${t.name || ''}" />
                </div>
                <div>
                  <label for="logo">Logo URL</label>
                  <input id="logo" class="input" value="${t.logoUrl || ''}" />
                </div>
                <div>
                  <label for="color">Brand Color</label>
                  <input id="color" class="input" type="color" value="${t.color || '#6ea8fe'}" />
                </div>
                <div>
                  <label for="welcome">Welcome Text</label>
                  <textarea id="welcome" class="input" rows="3">${t.welcome || ''}</textarea>
                </div>
                <div class="row tooltip" aria-live="polite">
                  <div class="chip">Code: <strong>${t.code}</strong></div>
                  <button class="btn sm" id="copy-code">Copy</button>
                </div>
              </div>
            </div>

            <div class="card" aria-labelledby="modules-title">
              <h3 id="modules-title">Modules</h3>
              <div class="list">
                ${['breathpacer','pranayama','strengthasana','mantras'].map(m => `
                  <label class="row" style="justify-content:space-between;">
                    <span style="text-transform:capitalize;">${m}</span>
                    <input type="checkbox" data-module="${m}" ${t.modules[m]?'checked':''} aria-label="Toggle ${m}" />
                  </label>
                `).join('')}
                <div class="space"></div>
                <label class="row" style="justify-content:space-between;">
                  <span>Studio Mode</span>
                  <input type="checkbox" id="studio-mode" ${t.studioMode?'checked':''} />
                </label>
                <div id="sub-teachers" class="list" ${t.studioMode?'':'hidden'}>
                  <div class="row">
                    <input id="sub-name" class="input" placeholder="Sub-teacher name" />
                    <input id="sub-email" class="input" type="email" placeholder="email@studio.com" />
                    <button id="add-sub" class="btn sm">Add</button>
                  </div>
                  ${t.subTeachers.map(st => `
                    <div class="row" style="justify-content:space-between;"> 
                      <span>${st.name} • ${st.email} • Code: <strong>${st.code}</strong></span>
                      <button class="btn ghost sm" data-del-sub="${st.id}">Remove</button>
                    </div>
                  `).join('')}
                </div>
              </div>
            </div>
          </div>

          <div class="card" aria-labelledby="seq-title">
            <h3 id="seq-title">Signature Sequences</h3>
            <div class="row">
              <button id="new-seq" class="btn">New Sequence</button>
              <span class="spacer"></span>
              <div class="small">Share: opens link to <code>#/portal?seq=&lt;id&gt;</code></div>
            </div>
            <div id="seq-list" class="list" style="margin-top:10px;"></div>
            <div id="seq-editor"></div>
          </div>

          <div class="grid cols-2">
            <div class="card" aria-labelledby="prog-title">
              <h3 id="prog-title">Programs</h3>
              <div class="row">
                <input id="prog-title-input" class="input" placeholder="Program title" />
                <button id="prog-add" class="btn sm">Create</button>
              </div>
              <div class="space"></div>
              <div id="prog-list" class="list"></div>
            </div>
            <div class="card" aria-labelledby="assign-title">
              <h3 id="assign-title">Assignments</h3>
              <div class="row">
                <select id="assign-prog"></select>
              </div>
              <div class="row">
                <input id="assign-codes" class="input" placeholder="Student codes (comma) or leave blank = All" />
                <button id="assign-btn" class="btn sm">Assign</button>
              </div>
              <div class="row">
                <input id="assign-due" class="input" type="date" aria-label="Due date (optional)" />
              </div>
              <div class="space"></div>
              <div class="row tooltip">
                <button id="invite-student" class="btn sm">Invite Student</button>
                <span class="small">Generates link to <code>#/join?code=${t.code}</code></span>
              </div>
              <div class="space"></div>
              <div id="assign-table" class="list"></div>
            </div>
          </div>

          <div class="card" aria-labelledby="mantra-title">
            <h3 id="mantra-title">Traditional Mantras</h3>
            <div class="row">
              <input id="m-search" class="input" placeholder="Search mantras or tags" />
              <button id="m-export" class="btn sm" aria-label="Export Mantras JSON">Export JSON</button>
              <button id="m-import" class="btn sm ghost" aria-label="Import Mantras JSON">Import JSON</button>
              <span class="spacer"></span>
              <a class="btn sm" href="#/mantra-generator" aria-label="Open Mantra Generator">Generator</a>
            </div>
            <div class="space"></div>
            <details class="drawer">
              <summary><strong>Create / Edit Mantra</strong></summary>
              <div class="space"></div>
              <div class="grid">
                <input id="mf-id" class="input" placeholder="ID (kebab-case)" />
                <input id="mf-title" class="input" placeholder="Title" />
                <input id="mf-dev" class="input" placeholder="Devanagari" />
                <input id="mf-trans" class="input" placeholder="Transliteration" />
                <input id="mf-meaning" class="input" placeholder="Meaning (short)" />
                <input id="mf-usage" class="input" placeholder="Usage (when/how)" />
                <input id="mf-recs" class="input" type="number" min="1" placeholder="Recommended recitations (e.g., 108)" />
                <input id="mf-tags" class="input" placeholder="Tags (comma)" />
                <div class="row">
                  <button id="mf-publish" class="btn sm success">Publish</button>
                  <button id="mf-draft" class="btn sm warn">Save Draft</button>
                  <span class="spacer"></span>
                  <button id="mf-reset" class="btn sm ghost">Reset</button>
                </div>
              </div>
            </details>
            <div class="space"></div>
            <div id="m-tags" class="row" role="group" aria-label="Tag filters"></div>
            <div class="space"></div>
            <div id="mantra-list" class="list"></div>
          </div>
          <!-- Mantra Generator moved to its own route -->
        </section>
      `;

      // Profile bindings
      document.getElementById('logout').addEventListener('click', () => { App.state.currentTeacherId = null; persist(); renderTeacherPortal(); });
      document.getElementById('copy-code').addEventListener('click', (e) => copyToClipboard(t.code, e.currentTarget));
      ['name','logo','color','welcome'].forEach(id => {
        const node = document.getElementById(id);
        node.addEventListener('input', () => {
          const map = { name: 'name', logo: 'logoUrl', color: 'color', welcome: 'welcome' };
          t[map[id]] = node.value;
          if (id === 'color') App.setTeacherColor(node.value);
          persist();
        });
      });

      // Modules toggle
      document.querySelectorAll('[data-module]').forEach(chk => {
        chk.addEventListener('change', (e) => {
          const key = e.currentTarget.getAttribute('data-module');
          t.modules[key] = e.currentTarget.checked; persist();
        });
      });
      const studioToggle = document.getElementById('studio-mode');
      studioToggle.addEventListener('change', (e) => { t.studioMode = e.currentTarget.checked; persist(); renderTeacherPortal(); });
      const addSub = document.getElementById('add-sub');
      if (addSub) addSub.addEventListener('click', () => {
        const name = document.getElementById('sub-name').value.trim();
        const email = document.getElementById('sub-email').value.trim();
        if (!name || !email) return;
        const st = { id: generateId('sub'), name, email, code: generateCode() };
        t.subTeachers.push(st); persist(); renderTeacherPortal();
      });
      document.querySelectorAll('[data-del-sub]').forEach(btn => btn.addEventListener('click', (e) => {
        const id = e.currentTarget.getAttribute('data-del-sub');
        t.subTeachers = t.subTeachers.filter(x => x.id !== id); persist(); renderTeacherPortal();
      }));

      // Sequences list
      const seqList = document.getElementById('seq-list');
      function drawSeqList() {
        seqList.innerHTML = t.sequences.map(s => `
          <div class="seq-item" data-seq="${s.id}">
            <div>
              <div class="row" style="gap:8px;">
                <strong>${s.title}</strong>
                ${statusChip(s.status || 'Draft')}
                ${shortTags(s.tags)}
              </div>
              <div class="small">Level: ${s.level || 'Beginner'} • Duration: ${s.duration || 0} min</div>
            </div>
            <div class="seq-actions" role="group" aria-label="Sequence actions">
              <button class="btn sm ghost" data-act="edit">Edit</button>
              <button class="btn sm ghost" data-act="dup">Duplicate</button>
              <button class="btn sm ghost tooltip" data-act="share">Share</button>
              <button class="btn sm danger" data-act="del">Delete</button>
            </div>
          </div>
        `).join('');
        seqList.querySelectorAll('.seq-item .btn').forEach(btn => btn.addEventListener('click', (e) => {
          const seqId = e.currentTarget.closest('.seq-item').getAttribute('data-seq');
          const act = e.currentTarget.getAttribute('data-act');
          const seq = t.sequences.find(x => x.id === seqId);
          if (act === 'edit') drawSeqEditor(seq);
          if (act === 'dup') { const copy = JSON.parse(JSON.stringify(seq)); copy.id = generateId('seq'); copy.title = seq.title + ' (Copy)'; t.sequences.unshift(copy); persist(); drawSeqList(); }
          if (act === 'share') {
            const link = location.origin + location.pathname + '#/portal?seq=' + seq.id + '&teacher=' + t.code;
            copyToClipboard(link, e.currentTarget);
            // Show QR via external image service (no JS libs)
            const img = new Image();
            img.alt = 'QR code for sequence link';
            img.src = 'https://api.qrserver.com/v1/create-qr-code/?size=160x160&data=' + encodeURIComponent(link);
            const host = e.currentTarget.closest('.seq-item');
            const row = el(`<div class="row" style="margin-top:8px;"></div>`);
            row.appendChild(img);
            host.appendChild(row);
          }
          if (act === 'del') { if (confirm('Delete sequence?')) { t.sequences = t.sequences.filter(x => x.id !== seqId); persist(); drawSeqList(); drawSeqEditor(null); } }
        }));
      }
      drawSeqList();

      document.getElementById('new-seq').addEventListener('click', () => {
        const ns = { id: generateId('seq'), title: 'Untitled', level: 'Beginner', tags: [], duration: 10, status: 'Draft', poses: [], breathNotes: '', mediaUrl: '' };
        t.sequences.unshift(ns); persist(); drawSeqList(); drawSeqEditor(ns);
      });

      function drawSeqEditor(seq) {
        const holder = document.getElementById('seq-editor');
        if (!seq) { holder.innerHTML = ''; return; }
        holder.innerHTML = `
          <div class="space"></div>
          <div class="card" aria-label="Sequence Editor">
            <div class="row" style="justify-content:space-between; align-items:center;">
              <strong>Edit: ${seq.title}</strong>
              <div class="row">
                <button class="btn sm success" id="pub">Publish</button>
                <button class="btn sm warn" id="draft">Save Draft</button>
              </div>
            </div>
            <div class="space"></div>
            <div class="grid">
              <div>
                <label>Title</label>
                <input id="seq-title" class="input" value="${seq.title}" />
              </div>
              <div class="row">
                <div style="flex:1;">
                  <label>Level</label>
                  <select id="seq-level" class="input">
                    ${['Beginner','Inter','Advanced'].map(l => `<option ${seq.level===l?'selected':''}>${l}</option>`).join('')}
                  </select>
                </div>
                <div style="width:140px;">
                  <label>Duration (min)</label>
                  <input id="seq-duration" class="input" type="number" min="1" value="${seq.duration || 0}" />
                </div>
              </div>
              <div>
                <label>Tags (comma)</label>
                <input id="seq-tags" class="input" value="${(seq.tags||[]).join(', ')}" />
              </div>
              <div>
                <label>Breath Notes</label>
                <textarea id="seq-breath" class="input" rows="3">${seq.breathNotes || ''}</textarea>
              </div>
              <div>
                <label>Media URL (optional)</label>
                <input id="seq-media" class="input" value="${seq.mediaUrl || ''}" />
              </div>
            </div>
            <div class="space"></div>
            <div class="row" style="justify-content:space-between; align-items:center;">
              <strong>Poses</strong>
              <button class="btn sm" id="add-pose">Add Pose</button>
            </div>
            <div id="pose-list" class="list" style="margin-top:8px;"></div>
          </div>
        `;
        const title = document.getElementById('seq-title');
        const level = document.getElementById('seq-level');
        const duration = document.getElementById('seq-duration');
        const tags = document.getElementById('seq-tags');
        const breath = document.getElementById('seq-breath');
        const media = document.getElementById('seq-media');
        function bindSave() {
          seq.title = title.value.trim() || 'Untitled';
          seq.level = level.value;
          seq.duration = parseInt(duration.value || '0', 10);
          seq.tags = tags.value.split(',').map(s=>s.trim()).filter(Boolean);
          seq.breathNotes = breath.value;
          seq.mediaUrl = media.value;
          persist();
          drawSeqList();
        }
        ;[title, level, duration, tags, breath, media].forEach(n => n.addEventListener('input', bindSave));
        document.getElementById('pub').addEventListener('click', () => { seq.status = 'Published'; persist(); drawSeqList(); });
        document.getElementById('draft').addEventListener('click', () => { seq.status = 'Draft'; persist(); drawSeqList(); });

        function drawPoses() {
          const list = document.getElementById('pose-list');
          if (!seq.poses) seq.poses = [];
          list.innerHTML = seq.poses.map((p, idx) => `
            <div class="pose-item" draggable="true" data-idx="${idx}" aria-grabbed="false">
              <div class="drag-handle" role="button" aria-label="Drag to reorder" title="Drag">≡</div>
              <div class="pose-fields">
                <div class="pose-row">
                  <input class="input" data-field="name" placeholder="Pose name" value="${p.name || ''}" />
                  <input class="input" data-field="cues" placeholder="Cues" value="${p.cues || ''}" />
                  <input class="input" data-field="hold" type="number" min="5" placeholder="Hold (sec)" value="${p.hold || 0}" />
                </div>
                <div class="pose-tools">
                  <button class="btn sm ghost" data-kb="up" aria-label="Move up">▲</button>
                  <button class="btn sm ghost" data-kb="down" aria-label="Move down">▼</button>
                  <button class="btn sm danger" data-del>Remove</button>
                </div>
              </div>
            </div>
          `).join('');

          // DnD
          list.querySelectorAll('.pose-item').forEach(item => {
            item.addEventListener('dragstart', (e) => {
              e.dataTransfer.setData('text/plain', item.getAttribute('data-idx'));
              item.setAttribute('aria-grabbed','true');
            });
            item.addEventListener('dragend', () => item.setAttribute('aria-grabbed','false'));
            item.addEventListener('dragover', (e) => e.preventDefault());
            item.addEventListener('drop', (e) => {
              e.preventDefault();
              const from = parseInt(e.dataTransfer.getData('text/plain'), 10);
              const to = parseInt(item.getAttribute('data-idx'), 10);
              if (from === to) return;
              const [moved] = seq.poses.splice(from, 1);
              seq.poses.splice(to, 0, moved);
              persist(); drawPoses();
            });
          });

          // Fallback buttons + field binding
          list.querySelectorAll('[data-kb]').forEach(btn => btn.addEventListener('click', (e) => {
            const row = e.currentTarget.closest('.pose-item');
            const idx = parseInt(row.getAttribute('data-idx'), 10);
            const dir = e.currentTarget.getAttribute('data-kb');
            const to = dir === 'up' ? Math.max(0, idx-1) : Math.min(seq.poses.length-1, idx+1);
            const [moved] = seq.poses.splice(idx, 1);
            seq.poses.splice(to, 0, moved);
            persist(); drawPoses();
          }));
          list.querySelectorAll('[data-del]').forEach(btn => btn.addEventListener('click', (e) => {
            const row = e.currentTarget.closest('.pose-item');
            const idx = parseInt(row.getAttribute('data-idx'), 10);
            seq.poses.splice(idx, 1); persist(); drawPoses();
          }));
          list.querySelectorAll('input[data-field]').forEach(inp => inp.addEventListener('input', (e) => {
            const row = e.currentTarget.closest('.pose-item');
            const idx = parseInt(row.getAttribute('data-idx'), 10);
            const field = e.currentTarget.getAttribute('data-field');
            let val = e.currentTarget.value;
            if (field === 'hold') val = parseInt(val || '0', 10);
            seq.poses[idx][field] = val; persist();
          }));
        }
        drawPoses();

        document.getElementById('add-pose').addEventListener('click', () => {
          seq.poses.push({ name: '', cues: '', hold: 30 }); persist(); drawPoses();
        });
      }

      // Programs
      const progList = document.getElementById('prog-list');
      const progSelect = document.getElementById('assign-prog');
      function drawPrograms() {
        progList.innerHTML = t.programs.map(p => `
          <div class="card" data-prog="${p.id}">
            <div class="row" style="justify-content:space-between;">
              <strong>${p.title}</strong>
              <div class="row">
                <button class="btn sm ghost" data-act="edit">Edit</button>
                <button class="btn sm danger" data-act="del">Delete</button>
              </div>
            </div>
            <div class="small">${p.description || ''}</div>
            <div class="space"></div>
            <div class="list">
              ${p.schedule.map(d => `<div class="row"><span class="chip">Day ${d.day}</span><span>${d.label}</span></div>`).join('')}
            </div>
          </div>
        `).join('');
        progList.querySelectorAll('[data-act]').forEach(btn => btn.addEventListener('click', (e) => {
          const pid = e.currentTarget.closest('[data-prog]').getAttribute('data-prog');
          const act = e.currentTarget.getAttribute('data-act');
          const prog = t.programs.find(x => x.id === pid);
          if (act === 'del') { if (confirm('Delete program?')) { t.programs = t.programs.filter(x => x.id !== pid); persist(); drawPrograms(); drawAssigns(); } }
          if (act === 'edit') editProgram(prog);
        }));
        // fill select
        progSelect.innerHTML = `<option value="">Select program</option>` + t.programs.map(p => `<option value="${p.id}">${p.title}</option>`).join('');
      }
      function editProgram(p) {
        const editor = el(`
          <div class="card" style="margin-top:10px;">
            <div class="row" style="justify-content:space-between;">
              <strong>Edit Program</strong>
              <button class="btn sm ghost" data-close>Close</button>
            </div>
            <div class="space"></div>
            <div class="grid">
              <input class="input" data-f="title" value="${p.title}" />
              <textarea class="input" data-f="description" rows="2" placeholder="Description">${p.description || ''}</textarea>
            </div>
            <div class="space"></div>
            <div class="list" id="sched"></div>
            <div class="space"></div>
            <div class="row">
              <button class="btn sm" data-add-day>Add Day</button>
            </div>
          </div>
        `);
        progList.parentElement.insertBefore(editor, progList.nextSibling);
        function drawSched() {
          const wrap = editor.querySelector('#sched');
          wrap.innerHTML = p.schedule.map((d, idx) => `
            <div class="pose-item" data-idx="${idx}">
              <div class="drag-handle">≡</div>
              <div class="pose-fields">
                <div class="pose-row">
                  <input class="input" data-f="day" type="number" min="1" value="${d.day}" />
                  <input class="input" data-f="label" value="${d.label}" />
                  <select class="input" data-f="sequenceId">
                    <option value="">No sequence</option>
                    ${t.sequences.map(s => `<option value="${s.id}" ${s.id===d.sequenceId?'selected':''}>${s.title}</option>`).join('')}
                  </select>
                </div>
                <div class="pose-tools">
                  <button class="btn sm ghost" data-kb="up">▲</button>
                  <button class="btn sm ghost" data-kb="down">▼</button>
                  <button class="btn sm danger" data-del>Remove</button>
                </div>
              </div>
            </div>
          `).join('');
          wrap.querySelectorAll('[data-f]').forEach(inp => inp.addEventListener('input', (e) => {
            const row = e.currentTarget.closest('[data-idx]');
            const idx = parseInt(row.getAttribute('data-idx'), 10);
            const f = e.currentTarget.getAttribute('data-f');
            let val = e.currentTarget.value;
            if (f === 'day') val = parseInt(val || '1', 10);
            p.schedule[idx][f] = val || '';
            persist();
          }));
          wrap.querySelectorAll('[data-kb]').forEach(btn => btn.addEventListener('click', (e) => {
            const row = e.currentTarget.closest('[data-idx]');
            const idx = parseInt(row.getAttribute('data-idx'), 10);
            const dir = e.currentTarget.getAttribute('data-kb');
            const to = dir === 'up' ? Math.max(0, idx-1) : Math.min(p.schedule.length-1, idx+1);
            const [moved] = p.schedule.splice(idx, 1);
            p.schedule.splice(to, 0, moved); persist(); drawSched();
          }));
          wrap.querySelectorAll('[data-del]').forEach(btn => btn.addEventListener('click', (e) => {
            const row = e.currentTarget.closest('[data-idx]');
            const idx = parseInt(row.getAttribute('data-idx'), 10);
            p.schedule.splice(idx, 1); persist(); drawSched();
          }));
          // DnD
          wrap.querySelectorAll('.pose-item').forEach(item => {
            item.setAttribute('draggable','true');
            item.addEventListener('dragstart', (e) => { e.dataTransfer.setData('text/plain', item.getAttribute('data-idx')); });
            item.addEventListener('dragover', (e) => e.preventDefault());
            item.addEventListener('drop', (e) => {
              e.preventDefault();
              const from = parseInt(e.dataTransfer.getData('text/plain'), 10);
              const to = parseInt(item.getAttribute('data-idx'), 10);
              const [moved] = p.schedule.splice(from, 1);
              p.schedule.splice(to, 0, moved); persist(); drawSched();
            });
          });
        }
        drawSched();
        editor.querySelector('[data-add-day]').addEventListener('click', () => { p.schedule.push({ day: p.schedule.length+1, label: 'New Day', sequenceId: '' }); persist(); drawSched(); });
        editor.querySelector('[data-close]').addEventListener('click', () => { editor.remove(); drawPrograms(); });
        // Title/desc save
        editor.querySelectorAll('[data-f]').forEach(inp => inp.addEventListener('input', (e) => {
          p[e.currentTarget.getAttribute('data-f')] = e.currentTarget.value; persist(); drawPrograms();
        }));
      }
      document.getElementById('prog-add').addEventListener('click', () => {
        const title = document.getElementById('prog-title-input').value.trim();
        if (!title) return;
        const prog = { id: generateId('prog'), title, description: '', schedule: [] };
        t.programs.unshift(prog); persist(); drawPrograms(); editProgram(prog);
      });
      drawPrograms();

      // Assignments
      function drawAssigns() {
        const wrap = document.getElementById('assign-table');
        if (t.assignments.length === 0) { wrap.innerHTML = `<div class="muted">No assignments yet.</div>`; return; }
        wrap.innerHTML = t.assignments.map(a => {
          const prog = t.programs.find(p => p.id === a.programId);
          const due = a.dueAt ? new Date(a.dueAt).toLocaleDateString() : '';
          return `<div class="row" style="justify-content:space-between;">
            <span class="chip">${a.studentCode}</span>
            <span>${prog?prog.title:'[deleted]'}</span>
            <span class="small">Assigned ${new Date(a.assignedAt).toLocaleDateString()}${due?` • Due ${due}`:''}</span>
          </div>`;
        }).join('');
      }
      document.getElementById('assign-btn').addEventListener('click', () => {
        const pid = /** @type {HTMLSelectElement} */(document.getElementById('assign-prog')).value;
        if (!pid) return;
        const codesRaw = /** @type {HTMLInputElement} */(document.getElementById('assign-codes')).value.trim();
        const codes = codesRaw ? codesRaw.split(',').map(s=>s.trim().toUpperCase()).filter(Boolean) : ['ALL'];
        const when = nowIso();
        const dueInput = /** @type {HTMLInputElement} */(document.getElementById('assign-due'));
        const dueAt = dueInput && dueInput.value ? new Date(dueInput.value + 'T23:59:59').toISOString() : null;
        if (codes.includes('ALL')) {
          if (t.students.length === 0) {
            // Create a general student roster for demo
            const code = generateCode(); t.students.push({ code, createdAt: when });
          }
          t.students.forEach(s => t.assignments.push({ studentCode: s.code, programId: pid, assignedAt: when, dueAt }));
        } else {
          codes.forEach(c => { if (!t.students.find(s => s.code === c)) t.students.push({ code: c, createdAt: when }); t.assignments.push({ studentCode: c, programId: pid, assignedAt: when, dueAt }); });
        }
        persist(); drawAssigns();
      });
      document.getElementById('invite-student').addEventListener('click', (e) => {
        const code = generateCode();
        t.students.push({ code, createdAt: nowIso() });
        const link = location.origin + location.pathname + '#/join?code=' + t.code;
        copyToClipboard(`${code} → ${link}`, e.currentTarget);
        persist(); drawAssigns();
      });
      drawAssigns();

      // Mantras
      function drawMantras() {
        const list = document.getElementById('mantra-list');
        const search = (document.getElementById('m-search').value || '').toLowerCase();
        const activeTags = Array.from(document.querySelectorAll('#m-tags .tag.active')).map(b => b.getAttribute('data-tag'));
        const items = (t.mantras||[]).map(upgradeMantraShape);
        const filtered = items.filter(m => {
          const matchesSearch = !search || [m.title, m.devanagari, m.transliteration, m.meaning, m.usage, (m.tags||[]).join(' ')].join(' ').toLowerCase().includes(search);
          const matchesTags = activeTags.length === 0 || (m.tags||[]).some(tag => activeTags.includes(tag));
          return matchesSearch && matchesTags;
        });
        const tagSet = new Set();
        items.forEach(m => (m.tags||[]).forEach(tag => tagSet.add(tag)));
        const tagWrap = document.getElementById('m-tags');
        tagWrap.innerHTML = Array.from(tagSet).sort().map(tag => `<button class="tag" data-tag="${tag}">${tag}</button>`).join('');
        tagWrap.querySelectorAll('.tag').forEach(btn => btn.addEventListener('click', (e) => {
          e.currentTarget.classList.toggle('active');
          drawMantras();
        }));

        list.innerHTML = filtered.map(m => `
          <div class="mantra-card" data-m="${m.id}">
            <div class="row" style="justify-content:space-between; align-items:flex-start;">
              <div>
                <div class="devanagari">${m.devanagari || ''}</div>
                <div class="translit">${m.transliteration || ''}</div>
                <strong>${m.title}</strong>
                <div class="small">${m.meaning || ''}</div>
                ${(m.tags||[]).map(tg => `<span class="chip">${tg}</span>`).join(' ')}
              </div>
              <div class="seq-actions">
                <button class="btn sm ghost" data-act="edit" aria-label="Edit mantra">Edit</button>
                <button class="btn sm ghost" data-act="dup" aria-label="Duplicate mantra">Duplicate</button>
                <button class="btn sm ghost" data-act="toggle" aria-label="Toggle publish">${(m.status||'draft')==='published'?'Unpublish':'Publish'}</button>
                <button class="btn sm danger" data-act="del" aria-label="Delete mantra">Delete</button>
              </div>
            </div>
          </div>
        `).join('');

        list.querySelectorAll('[data-act]').forEach(btn => btn.addEventListener('click', (e) => {
          const id = e.currentTarget.closest('[data-m]').getAttribute('data-m');
          const act = e.currentTarget.getAttribute('data-act');
          const idx = (t.mantras||[]).findIndex(x => upgradeMantraShape(x).id === id);
          if (idx < 0) return;
          if (act === 'edit') fillMantraForm(upgradeMantraShape(t.mantras[idx]));
          if (act === 'dup') { const src = upgradeMantraShape(t.mantras[idx]); const dupe = { ...src, id: src.id + '-copy', title: src.title + ' (Copy)' }; t.mantras.unshift(dupe); persist(); drawMantras(); }
          if (act === 'toggle') { const cur = upgradeMantraShape(t.mantras[idx]); t.mantras[idx] = { ...cur, status: (cur.status||'draft')==='published'?'draft':'published' }; persist(); drawMantras(); }
          if (act === 'del') { t.mantras.splice(idx, 1); persist(); drawMantras(); }
        }));

        // Export / Import
        document.getElementById('m-export').onclick = () => {
          const data = JSON.stringify((t.mantras||[]).map(upgradeMantraShape), null, 2);
          const blob = new Blob([data], { type: 'application/json' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a'); a.href = url; a.download = 'mantras.json'; a.click(); URL.revokeObjectURL(url);
        };
        document.getElementById('m-import').onclick = () => {
          const json = prompt('Paste mantras JSON');
          if (!json) return;
          try { const arr = JSON.parse(json); if (Array.isArray(arr)) { t.mantras = dedupeMantras(arr.map(upgradeMantraShape)); persist(); drawMantras(); } }
          catch(e){ alert('Invalid JSON'); }
        };
        if (App._dupesRemoved && !App._dupesToastShown) { showToast(App._dupesRemoved + ' duplicates removed.'); App._dupesToastShown = true; }
      }

      function fillMantraForm(m) {
        document.getElementById('mf-id').value = m.id || '';
        document.getElementById('mf-title').value = m.title || '';
        document.getElementById('mf-dev').value = m.devanagari || '';
        document.getElementById('mf-trans').value = m.transliteration || '';
        document.getElementById('mf-meaning').value = m.meaning || '';
        document.getElementById('mf-usage').value = m.usage || '';
        document.getElementById('mf-recs').value = m.recs || '';
        document.getElementById('mf-tags').value = (m.tags||[]).join(', ');
      }

      // Mantra form actions
      (function bindMantraForm(){
        const pub = document.getElementById('mf-publish');
        const draft = document.getElementById('mf-draft');
        const reset = document.getElementById('mf-reset');
        const search = document.getElementById('m-search');
        if (pub) pub.addEventListener('click', () => saveMantra('published'));
        if (draft) draft.addEventListener('click', () => saveMantra('draft'));
        if (reset) reset.addEventListener('click', () => fillMantraForm({ id: '', title: '', devanagari: '', transliteration: '', meaning: '', usage: '', recs: '', tags: [] }));
        if (search) search.addEventListener('input', () => drawMantras());
      })();

      function saveMantra(status) {
        const idInput = document.getElementById('mf-id');
        let id = (idInput.value || '').trim() || kebabIdFromTitle(document.getElementById('mf-title').value);
        id = id.toLowerCase();
        const mantra = upgradeMantraShape({
          id,
          title: document.getElementById('mf-title').value.trim(),
          devanagari: document.getElementById('mf-dev').value.trim(),
          transliteration: document.getElementById('mf-trans').value.trim(),
          meaning: document.getElementById('mf-meaning').value.trim(),
          usage: document.getElementById('mf-usage').value.trim(),
          recs: parseInt(document.getElementById('mf-recs').value || '0', 10) || undefined,
          tags: (document.getElementById('mf-tags').value || '').split(',').map(s=>s.trim()).filter(Boolean),
          status
        });
        t.mantras = t.mantras || [];
        const idx = t.mantras.findIndex(x => upgradeMantraShape(x).id === id);
        if (idx >= 0) t.mantras[idx] = mantra; else t.mantras.unshift(mantra);
        persist(); drawMantras(); fillMantraForm({ id: '', title: '', devanagari: '', transliteration: '', meaning: '', usage: '', recs: '', tags: [] });
      }

      // Initialize teacher's mantras with global seed if empty
      if (!Array.isArray(t.mantras) || t.mantras.length === 0) {
        t.mantras = GLOBAL_MANTRAS.map(m => ({ ...m }));
        persist();
      }
      drawMantras();

      // -------- Mantra Generator (route-based) --------
      function setupGenUI(){
        const intents = ['focus','calm','protection','healing','learning','compassion','clarity','stillness','energy'];
        const wrap = document.getElementById('mgen-intents'); if (!wrap) return;
        wrap.innerHTML = intents.map(i => `<button class="tag" data-intent="${i}">${i}</button>`).join('');
        wrap.querySelectorAll('.tag').forEach(b => b.addEventListener('click', (e) => { e.currentTarget.classList.toggle('active'); updatePreview(); }));
        ['mgen-seed','mgen-pattern','mgen-recs','mgen-dev','mgen-trans'].forEach(id => document.getElementById(id).addEventListener('input', updatePreview));
        document.getElementById('mgen-generate').addEventListener('click', updatePreview);
        document.getElementById('mgen-save-draft').addEventListener('click', () => saveFromPreview('draft'));
        document.getElementById('mgen-publish').addEventListener('click', () => saveFromPreview('published'));
        document.getElementById('mgen-copy').addEventListener('click', () => copyToClipboard(JSON.stringify(currentPreview(), null, 2), document.getElementById('mgen-copy')));
        document.getElementById('mgen-export').addEventListener('click', () => {
          const data = JSON.stringify(currentPreview(), null, 2);
          const blob = new Blob([data], { type: 'application/json' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a'); a.href = url; a.download = 'mantra.json'; a.click(); URL.revokeObjectURL(url);
        });
        updatePreview();
      }
      function selectedIntents(){ return Array.from(document.querySelectorAll('#mgen-intents .tag.active')).map(b => b.getAttribute('data-intent')); }
      function currentPreview(){
        const seed = document.getElementById('mgen-seed').value;
        const pattern = document.getElementById('mgen-pattern').value;
        const recs = parseInt(document.getElementById('mgen-recs').value || '108', 10);
        const incDev = document.getElementById('mgen-dev').checked;
        const incTrans = document.getElementById('mgen-trans').checked;
        const intents = selectedIntents();
        return generateMantra({ seed, pattern, recs, incDev, incTrans, intents });
      }
      function updatePreview(){
        const m = currentPreview();
        const p = document.getElementById('mgen-preview');
        p.innerHTML = `
          <div class="row" style="justify-content:space-between; align-items:flex-start;">
            <div>
              <div class="devanagari">${m.devanagari||''}</div>
              <div class="translit">${m.transliteration||''}</div>
              <strong>${m.title}</strong>
              <div class="small">${m.meaning||''}</div>
              <div class="muted">${m.usage||''}</div>
              <div class="row" style="margin-top:6px;">${(m.tags||[]).map(tg => `<span class='chip'>${tg}</span>`).join(' ')}</div>
              <div class="small" style="margin-top:6px;">Recitations: ${m.recs||''}</div>
            </div>
          </div>
        `;
      }
      function saveFromPreview(status){
        const m = currentPreview();
        const baseId = slug(m.title || 'mantra');
        const id = makeUniqueId(baseId, t);
        const entry = { ...m, id, status };
        t.mantras = t.mantras || [];
        t.mantras.unshift(entry);
        persist(); drawMantras(); showToast(status==='published' ? 'Mantra published' : 'Mantra saved');
      }
      function generateMantra({ seed, pattern, recs, incDev, incTrans, intents }){
        const tags = intents || [];
        let title = seed;
        let devanagari = '';
        let transliteration = '';
        let meaning = '';
        let usage = '';
        if (pattern === 'Breath-sync') {
          if (seed === 'So’ham') { devanagari = 'सोऽहम्'; transliteration = "So’ham"; title = 'So’ham'; meaning = 'I am That.'; usage = 'Sync with breath: So (inhale) — Ham (exhale).'; }
          else { title = `${seed} Prāṇayoga`; usage = 'Sync with breath.'; }
        } else if (pattern === 'Invocation') {
          const intent = (intents[0]||'').toLowerCase();
          const deityMap = { protection:'Durgā', beginnings:'Gaṇeśa', learning:'Sarasvatī', clarity:'Gāyatrī' };
          const deity = deityMap[intent] || 'Gaṇeśa';
          title = `Om ${deity} namaḥ`;
          transliteration = `Om ${deity} namaḥ`;
          usage = 'Invocation.';
        } else if (pattern === 'Affirmation') {
          const map = { focus:'Steady mind, clear sight.', calm:'I rest in ease.', protection:'I am protected.', healing:'I heal and renew.', learning:'I learn and express.', compassion:'I act with kindness.', clarity:'I see clearly.', stillness:'I am stillness.', energy:'I am vibrant energy.' };
          title = map[(intents[0]||'focus')] || 'I am present.';
          meaning = title; usage = 'Affirmation.';
        }
        const m = { id:'', title, devanagari: incDev ? devanagari : '', transliteration: incTrans ? transliteration : '', meaning, usage, recs, tags, status:'draft' };
        return m;
      }

      AppRoot.focus();
    }

    // Student Portal
    function renderStudentPortal(query) {
      // Resolve teacher from activeTeacherId or query teacher code
      let t = App.activeTeacher;
      if (!t && query.teacher) {
        const byCode = teacherByCode(query.teacher);
        if (byCode) { App.state.activeTeacherId = byCode.id; t = byCode; persist(); }
      }
      if (!t) { navigate('#/join'); return; }
      setToolbarForTeacher(t);
      const tabs = [];
      if (t.modules.strengthasana) tabs.push('Assigned','Strengthāsana');
      if (t.modules.mantras) tabs.push('Mantras');
      if (t.modules.breathpacer) tabs.push('BreathPacer');
      if (t.modules.pranayama) tabs.push('Paripūrṇa Prāṇa');
      const activeTab = tabs[0] || '';
      const logo = t.logoUrl ? `<img alt="${t.name} logo" src="${t.logoUrl}" style="width:56px;height:56px;object-fit:contain;border-radius:10px;" />` : '';

      AppRoot.innerHTML = `
        <section class="grid" aria-label="Student Portal">
          <div class="card">
            <div class="row" style="align-items:center; gap:12px;">
              ${logo}
              <div>
                <div class="row" style="gap:8px; align-items:center;">
                  <strong style="font-size:18px;">${t.name}</strong>
                  <span class="chip" title="Teacher Code">${t.code}</span>
                </div>
                <div class="small">${t.welcome || ''}</div>
              </div>
            </div>
          </div>
          <div class="tabs" role="tablist">
            ${tabs.map((tab, i) => `<button role="tab" class="tab" data-tab="${tab}" aria-selected="${i===0?'true':'false'}">${tab}</button>`).join('')}
          </div>
          <div id="tab-content"></div>
        </section>
      `;

      function activate(tab) {
        document.querySelectorAll('.tab').forEach(b => b.setAttribute('aria-selected', b.getAttribute('data-tab') === tab ? 'true' : 'false'));
        const host = document.getElementById('tab-content');
        host.innerHTML = '';
        if (tab === 'Assigned') drawAssigned(host, t);
        if (tab === 'Strengthāsana') drawStrength(host, t, query);
        if (tab === 'Mantras') drawMantrasStudent(host, t);
        if (tab === 'BreathPacer') drawBreathPacer(host);
        if (tab === 'Paripūrṇa Prāṇa') drawPranayama(host);
      }
      document.querySelectorAll('.tab').forEach(btn => btn.addEventListener('click', (e) => activate(e.currentTarget.getAttribute('data-tab'))));
      activate(activeTab);
      AppRoot.focus();
    }

    // Traditional Mantras route view (teacher list/management without generator)
    function renderTraditionalMantras() {
      const t = App.teacher || App.activeTeacher || App.state.teachers[App.state.demoTeacherId];
      if (!t) { navigate('#/join'); return; }
      setToolbarForTeacher(t);
      AppRoot.innerHTML = `
        <section class="grid" aria-label="Traditional Mantras">
          <div class="card">
            <div class="row" style="justify-content:space-between; align-items:center;">
              <strong>Traditional Mantras</strong>
              <div class="row">
                <a class="btn sm" href="#/mantra-generator" aria-label="Open Mantra Generator">Generator</a>
              </div>
            </div>
            <div class="space"></div>
            <div class="row">
              <input id="tm-search" class="input" placeholder="Search mantras or tags" aria-label="Search" />
              <select id="tm-status" class="input" aria-label="Status filter" style="max-width:180px;">
                <option value="">All</option>
                <option value="published">Published</option>
                <option value="draft">Draft</option>
              </select>
              <span class="spacer"></span>
              <button id="tm-export" class="btn sm" aria-label="Export JSON">Export JSON</button>
              <button id="tm-import" class="btn sm ghost" aria-label="Import JSON">Import JSON</button>
            </div>
            <div class="space"></div>
            <div id="tm-tags" class="row" role="group" aria-label="Tag filters"></div>
            <div class="space"></div>
            <div id="tm-list" class="list"></div>
          </div>
        </section>
      `;
      const search = document.getElementById('tm-search');
      const statusSel = document.getElementById('tm-status');
      const list = document.getElementById('tm-list');
      const tagsWrap = document.getElementById('tm-tags');
      function draw() {
        const q = (search.value || '').toLowerCase();
        const status = statusSel.value;
        const items = (t.mantras||[]).map(upgradeMantraShape);
        const filtered = items.filter(m => {
          const inSearch = !q || [m.title,m.devanagari,m.transliteration,m.meaning,m.usage,(m.tags||[]).join(' ')].join(' ').toLowerCase().includes(q);
          const inStatus = !status || (m.status||'draft') === status;
          const activeTags = Array.from(tagsWrap.querySelectorAll('.tag.active')).map(b => b.getAttribute('data-tag'));
          const inTags = activeTags.length===0 || (m.tags||[]).some(tg => activeTags.includes(tg));
          return inSearch && inStatus && inTags;
        });
        // tags
        const tagSet = new Set(); items.forEach(m => (m.tags||[]).forEach(tg => tagSet.add(tg)));
        tagsWrap.innerHTML = Array.from(tagSet).sort().map(tg => `<button class="tag" data-tag="${tg}">${tg}</button>`).join('');
        tagsWrap.querySelectorAll('.tag').forEach(b => b.addEventListener('click', (e) => { e.currentTarget.classList.toggle('active'); draw(); }));
        list.innerHTML = filtered.map(m => `
          <div class="mantra-card" data-m="${m.id}">
            <div class="row" style="justify-content:space-between; align-items:flex-start;">
              <div>
                <div class="devanagari">${m.devanagari||''}</div>
                <div class="translit">${m.transliteration||''}</div>
                <strong>${m.title}</strong>
                <div class="small">${m.meaning||''}</div>
                ${(m.tags||[]).map(tg => `<span class="chip">${tg}</span>`).join(' ')}
              </div>
              <div class="seq-actions">
                <button class="btn sm ghost" data-act="edit">Edit</button>
                <button class="btn sm ghost" data-act="toggle">${(m.status||'draft')==='published'?'Unpublish':'Publish'}</button>
                <button class="btn sm danger" data-act="del">Delete</button>
                <button class="btn sm" data-act="export">Export</button>
              </div>
            </div>
          </div>`).join('');
        list.querySelectorAll('[data-act]').forEach(btn => btn.addEventListener('click', (e) => {
          const id = e.currentTarget.closest('[data-m]').getAttribute('data-m');
          const act = e.currentTarget.getAttribute('data-act');
          const idx = (t.mantras||[]).findIndex(x => upgradeMantraShape(x).id === id);
          if (idx < 0) return;
          if (act === 'edit') {
            const m = upgradeMantraShape(t.mantras[idx]); fillMantraForm(m); document.querySelector('details.drawer summary')?.click();
          }
          if (act === 'toggle') { const cur = upgradeMantraShape(t.mantras[idx]); t.mantras[idx] = { ...cur, status: (cur.status||'draft')==='published'?'draft':'published' }; persist(); draw(); }
          if (act === 'del') { t.mantras.splice(idx,1); persist(); draw(); }
          if (act === 'export') {
            const data = JSON.stringify([upgradeMantraShape(t.mantras[idx])], null, 2);
            const blob = new Blob([data], { type:'application/json' }); const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href=url; a.download=`mantra-${id}.json`; a.click(); URL.revokeObjectURL(url);
          }
        }));
        // One-time duplicates toast
        if (App._dupesRemoved && !App._dupesToastShown) { showToast(App._dupesRemoved + ' duplicates removed.'); App._dupesToastShown = true; }
      }
      document.getElementById('tm-export').onclick = () => {
        const data = JSON.stringify((t.mantras||[]).map(upgradeMantraShape), null, 2);
        const blob = new Blob([data], { type:'application/json' }); const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href=url; a.download='mantras.json'; a.click(); URL.revokeObjectURL(url);
      };
      document.getElementById('tm-import').onclick = () => {
        const json = prompt('Paste mantras JSON'); if (!json) return;
        try { const arr = JSON.parse(json); if (Array.isArray(arr)) { t.mantras = dedupeMantras(arr.map(upgradeMantraShape)); persist(); draw(); } }
        catch(e){ alert('Invalid JSON'); }
      };
      search.addEventListener('input', draw);
      statusSel.addEventListener('change', draw);
      draw();
      AppRoot.focus();
    }

    // Mantra Generator route view
    function renderMantraGenerator() {
      const t = App.teacher || App.state.teachers[App.state.demoTeacherId];
      if (!t) { navigate('#/join'); return; }
      setToolbarForTeacher(t);
      AppRoot.innerHTML = `
        <section class="grid" aria-label="Mantra Generator">
          <div class="grid cols-2">
            <div class="card">
              <strong>Mantra Generator</strong>
              <div class="space"></div>
              <div class="grid">
                <div>
                  <div class="small">Intent</div>
                  <div id="mgen-intents" class="row"></div>
                </div>
                <div>
                  <label>Bīja Seed</label>
                  <select id="mgen-seed" class="input">
                    <option>Om</option>
                    <option>So’ham</option>
                    <option>Śāntiḥ</option>
                    <option>Hrīṃ</option>
                    <option>Aiṃ</option>
                    <option>Klīṃ</option>
                    <option>Gaṃ</option>
                    <option>Dum</option>
                  </select>
                </div>
                <div>
                  <label>Pattern</label>
                  <select id="mgen-pattern" class="input">
                    <option>Breath-sync</option>
                    <option>Invocation</option>
                    <option>Affirmation</option>
                  </select>
                </div>
                <div class="row">
                  <input id="mgen-recs" class="input" type="number" min="1" value="108" aria-label="Recitations" style="max-width:140px;" />
                  <label class="row" style="gap:6px;">
                    <input id="mgen-dev" type="checkbox" checked /> Include Devanāgarī
                  </label>
                  <label class="row" style="gap:6px;">
                    <input id="mgen-trans" type="checkbox" checked /> Include Transliteration
                  </label>
                </div>
              </div>
              <div class="space"></div>
              <div class="row" style="justify-content:flex-end; gap:8px;">
                <button id="mgen-generate" class="btn sm" aria-label="Generate">Generate</button>
                <button id="mgen-save-draft" class="btn sm ghost" aria-label="Save Draft">Save as Draft</button>
                <button id="mgen-publish" class="btn sm success" aria-label="Publish">Publish</button>
                <button id="mgen-copy" class="btn sm" aria-label="Copy JSON">Copy</button>
                <button id="mgen-export" class="btn sm" aria-label="Export JSON">Export JSON</button>
              </div>
            </div>
            <div class="card">
              <strong>Preview</strong>
              <div class="space"></div>
              <div id="mgen-preview" class="drawer"></div>
            </div>
          </div>
        </section>
      `;
      setupGenUI();
      AppRoot.focus();
    }

    function drawAssigned(host, t) {
      const assignments = t.assignments;
      if (assignments.length === 0) { host.appendChild(el(`<div class="card"><div class="muted">No assignments yet.</div></div>`)); return; }
      host.appendChild(el(`<div class="card"><h3>Assigned Programs</h3></div>`));
      assignments.forEach(a => {
        const prog = t.programs.find(p => p.id === a.programId);
        if (!prog) return;
        const card = el(`<div class="card"></div>`);
        card.innerHTML = `
          <div class="row" style="justify-content:space-between;">
            <strong>${prog.title}</strong>
            <span class="small">Assigned ${new Date(a.assignedAt).toLocaleDateString()}</span>
          </div>
          <div class="small">${prog.description || ''}</div>
          <div class="space"></div>
          <div class="list">${prog.schedule.map((d, idx) => {
            const doneKey = `done:${prog.id}:${d.day}`;
            const done = localStorage.getItem(doneKey) === '1';
            return `<div class="row" style="justify-content:space-between;">
              <span><span class="chip">Day ${d.day}</span> ${d.label}</span>
              <button class="btn sm ${done?'success':''}" data-done="${doneKey}">${done?'Completed':'Mark complete'}</button>
            </div>`;
          }).join('')}</div>
        `;
        card.querySelectorAll('[data-done]').forEach(btn => btn.addEventListener('click', (e) => {
          const key = e.currentTarget.getAttribute('data-done');
          const done = localStorage.getItem(key) === '1';
          if (!done) localStorage.setItem(key, '1'); else localStorage.removeItem(key);
          // analytics completion when sequenceId exists
          const dayIdx = parseInt(key.split(':').pop(), 10) - 1;
          const sched = prog.schedule[dayIdx];
          if (sched?.sequenceId) t.analytics.completions.push({ studentCode: 'anon', sequenceId: sched.sequenceId, at: nowIso() });
          persist(); drawAssigned(host, t);
        }));
        host.appendChild(card);
      });
    }

    function drawStrength(host, t, query) {
      const published = t.sequences.filter(s => (s.status || 'Draft') === 'Published');
      const wrap = el(`<div class="grid"></div>`);
      const list = el(`<div class="list"></div>`);
      if (published.length === 0) list.innerHTML = `<div class="card"><div class="muted">No published sequences yet.</div></div>`;
      published.forEach(s => {
        const item = el(`<div class="seq-item" data-seq="${s.id}">
          <div>
            <strong>${s.title}</strong>
            <div class="small">Level: ${s.level} • ${s.duration} min</div>
          </div>
          <div class="seq-actions">
            <button class="btn sm" data-play>Open</button>
          </div>
        </div>`);
        item.querySelector('[data-play]').addEventListener('click', () => openPlayer(s));
        list.appendChild(item);
      });
      wrap.appendChild(list);
      const playerHost = el(`<div id="player-host"></div>`);
      wrap.appendChild(playerHost);
      host.appendChild(wrap);
      if (query.seq) {
        const target = published.find(s => s.id === query.seq);
        if (target) openPlayer(target);
      }

      function openPlayer(seq) {
        playerHost.innerHTML = '';
        const card = el(`<div class="card player"></div>`);
        card.innerHTML = `
          <div class="row" style="justify-content:space-between;">
            <strong>${seq.title}</strong>
            <button class="btn sm ghost" id="close-player">Close</button>
          </div>
          <div class="small">${seq.breathNotes || ''}</div>
          <div id="pose-stage"></div>
          <div class="row" style="justify-content:center; gap:8px;">
            <button class="btn" id="play">Start</button>
            <button class="btn ghost" id="pause">Pause</button>
            <button class="btn ghost" id="next">Next</button>
          </div>
        `;
        playerHost.appendChild(card);
        document.getElementById('close-player').addEventListener('click', () => { playerHost.innerHTML=''; });
        const stage = document.getElementById('pose-stage');
        let idx = 0; let remaining = 0; let timer = null; let running = false;
        function renderPose() {
          const p = seq.poses[idx];
          if (!p) { stage.innerHTML = '<div class="muted">Done</div>'; return; }
          remaining = p.hold || 0;
          stage.innerHTML = `
            <div class="card">
              <div class="row" style="justify-content:space-between;">
                <strong>${p.name}</strong>
                <span class="chip">${idx+1}/${seq.poses.length}</span>
              </div>
              <div class="muted">${p.cues || ''}</div>
              <div class="timer" aria-live="polite" id="timer">${remaining}s</div>
            </div>
          `;
        }
        function tick() {
          if (!running) return;
          const tEl = document.getElementById('timer'); if (!tEl) return;
          if (remaining <= 0) { nextPose(); return; }
          remaining -= 1; tEl.textContent = remaining + 's';
          timer = setTimeout(tick, 1000);
        }
        function start() { if (running) return; running = true; tick(); }
        function pause() { running = false; if (timer) clearTimeout(timer); }
        function nextPose() { pause(); idx = Math.min(seq.poses.length, idx + 1); renderPose(); start(); }
        document.getElementById('play').addEventListener('click', start);
        document.getElementById('pause').addEventListener('click', pause);
        document.getElementById('next').addEventListener('click', nextPose);
        renderPose();
      }
    }

    function drawMantrasStudent(host, t) {
      const wrap = el(`<div class="card"></div>`);
      const controls = el(`<div class="row"></div>`);
      const search = el(`<input class="input" placeholder="Search mantras" aria-label="Search mantras" />`);
      const tagsHost = el(`<div class="row" style="margin-top:8px;"></div>`);
      controls.appendChild(search);
      wrap.appendChild(controls);
      wrap.appendChild(tagsHost);
      const grid = el(`<div class="mantra-grid" style="margin-top:12px;"></div>`);
      wrap.appendChild(grid);
      host.appendChild(wrap);

      const all = getAllMantrasForTeacher(t, true);
      const tagSet = new Set(); all.forEach(m => (m.tags||[]).forEach(tag => tagSet.add(tag)));
      tagsHost.innerHTML = Array.from(tagSet).sort().map(tag => `<button class="tag" data-tag="${tag}">${tag}</button>`).join('');
      tagsHost.querySelectorAll('.tag').forEach(btn => btn.addEventListener('click', (e) => { e.currentTarget.classList.toggle('active'); draw(); }));
      search.addEventListener('input', draw);

      function draw() {
        const q = (search.value || '').toLowerCase();
        const activeTags = Array.from(tagsHost.querySelectorAll('.tag.active')).map(b => b.getAttribute('data-tag'));
        const items = getAllMantrasForTeacher(t, true).filter(m => {
          const matchesSearch = !q || [m.title, m.devanagari, m.transliteration, m.meaning, m.usage, (m.tags||[]).join(' ')].join(' ').toLowerCase().includes(q);
          const matchesTags = activeTags.length === 0 || (m.tags||[]).some(tag => activeTags.includes(tag));
          return matchesSearch && matchesTags;
        });
        grid.innerHTML = items.map(m => `
          <div class="mantra-card" data-m="${m.id}">
            <div class="devanagari">${m.devanagari || ''}</div>
            <div class="translit">${m.transliteration || ''}</div>
            <strong>${m.title}</strong>
            <div class="small">${m.meaning || ''}</div>
            <div class="row">${(m.tags||[]).map(tg => `<span class="chip">${tg}</span>`).join(' ')}</div>
            <div class="row" style="justify-content:flex-end;">
              <button class="btn sm" data-open aria-label="Open details">Details</button>
            </div>
          </div>
        `).join('');
        grid.querySelectorAll('[data-open]').forEach(btn => btn.addEventListener('click', (e) => openDrawer(e.currentTarget.closest('[data-m]').getAttribute('data-m'))));
      }

      function openDrawer(id) {
        const m = getAllMantrasForTeacher(t, true).find(x => x.id === id);
        if (!m) return;
        const drawer = el(`<div class="drawer"></div>`);
        drawer.innerHTML = `
          <div class="row" style="justify-content:space-between;">
            <strong>${m.title}</strong>
            <button class="btn sm ghost" data-close aria-label="Close">Close</button>
          </div>
          <div class="devanagari" style="margin-top:6px;">${m.devanagari || ''}</div>
          <div class="translit">${m.transliteration || ''}</div>
          <div class="small" style="margin-top:6px;">${m.meaning || ''}</div>
          <div class="muted" style="margin-top:6px;">${m.usage || ''}</div>
          <div class="row" style="margin-top:8px;">
            ${((m.tags||[]).map(tg => `<span class=\"chip\">${tg}</span>`).join(' '))}
          </div>
          <div class="row" style="justify-content:flex-end; margin-top:8px; gap:8px;">
            <button class="btn sm" data-rec aria-label="Add recitation">Recite</button>
            <span class="small" id="rec-count"></span>
          </div>
        `;
        const recKey = `rec-count:${t.id}:${m.id}`;
        const cntNode = drawer.querySelector('#rec-count');
        function updateCount() { const n = parseInt(localStorage.getItem(recKey) || '0', 10); cntNode.textContent = n ? `${n} recitations` : ''; }
        updateCount();
        drawer.querySelector('[data-rec]').addEventListener('click', () => {
          const n = parseInt(localStorage.getItem(recKey) || '0', 10) + 1; localStorage.setItem(recKey, String(n)); updateCount();
        });
        drawer.querySelector('[data-close]').addEventListener('click', () => drawer.remove());
        host.appendChild(drawer);
        drawer.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }

      draw();
    }

    function drawBreathPacer(host) {
      const card = el(`<div class="card"></div>`);
      card.innerHTML = `
        <h3>Breath Pacer</h3>
        <div class="row" style="justify-content:center; gap:12px;">
          <div id="circle" class="breath-circle" aria-label="Breathing circle"></div>
        </div>
        <div class="row" style="justify-content:center; gap:8px;">
          <label class="sr-only" for="inhale">Inhale</label>
          <input id="inhale" class="input" type="number" min="1" value="4" style="width:90px;" />
          <label class="sr-only" for="hold">Hold</label>
          <input id="hold" class="input" type="number" min="0" value="0" style="width:90px;" />
          <label class="sr-only" for="exhale">Exhale</label>
          <input id="exhale" class="input" type="number" min="1" value="6" style="width:90px;" />
          <button id="bp-start" class="btn">Start</button>
          <button id="bp-stop" class="btn ghost">Stop</button>
        </div>
      `;
      host.appendChild(card);
      const circle = card.querySelector('#circle');
      let seq = []; let i = 0; let timeout = null; let running = false;
      function step() {
        if (!running) return; const cur = seq[i % seq.length];
        if (cur.type === 'inhale') circle.style.transform = 'scale(1.2)';
        if (cur.type === 'exhale') circle.style.transform = 'scale(0.9)';
        if (cur.type === 'hold') circle.style.transform = 'scale(1.05)';
        timeout = setTimeout(() => { i++; step(); }, cur.ms);
      }
      function start() {
        const inh = Math.max(1, parseInt(card.querySelector('#inhale').value || '4', 10));
        const h = Math.max(0, parseInt(card.querySelector('#hold').value || '0', 10));
        const exh = Math.max(1, parseInt(card.querySelector('#exhale').value || '6', 10));
        seq = [ { type: 'inhale', ms: inh*1000 }, ...(h? [{type:'hold', ms:h*1000}] : []), { type: 'exhale', ms: exh*1000 } ];
        running = true; i = 0; step();
      }
      function stop() { running = false; if (timeout) clearTimeout(timeout); circle.style.transform = 'scale(1)'; }
      card.querySelector('#bp-start').addEventListener('click', start);
      card.querySelector('#bp-stop').addEventListener('click', stop);
    }

    function drawPranayama(host) {
      const card = el(`<div class="card"></div>`);
      card.innerHTML = `
        <h3>Paripūrṇa Prāṇa</h3>
        <div class="row" style="gap:8px;">
          <button class="btn sm" data-pres="4-7-8">4-7-8</button>
          <button class="btn sm" data-pres="box">Box 4-4-4-4</button>
          <button class="btn sm" data-pres="6-2-6">6-2-6</button>
        </div>
        <div id="pp-host"></div>
      `;
      host.appendChild(card);
      const ph = card.querySelector('#pp-host');
      function renderPreset(name, inh, hold1, ex, hold2) {
        ph.innerHTML = `<div class="small">Preset: ${name}</div>`;
        drawBreathPacer(ph);
        // Fill values
        const inputMap = ph.querySelectorAll('input');
        inputMap[0].value = inh; inputMap[1].value = hold1; inputMap[2].value = ex;
      }
      card.querySelectorAll('[data-pres]').forEach(btn => btn.addEventListener('click', (e) => {
        const p = e.currentTarget.getAttribute('data-pres');
        if (p === '4-7-8') renderPreset('4-7-8', 4, 7, 8, 0);
        if (p === 'box') renderPreset('Box', 4, 4, 4, 4);
        if (p === '6-2-6') renderPreset('6-2-6', 6, 2, 6, 0);
      }));
    }

    // Postures data (seed replaced by user's provided dataset)
    const POSES = [
      {"english":"Sun Salutation A","sanskrit":"सूर्य नमस्कार A","transliteration":"Sūrya Namaskāra A","level":"Beginner","category":"Transition","tags":["vinyasa","warmup"],"image":"","notes":""},
      {"english":"Sun Salutation B","sanskrit":"सूर्य नमस्कार B","transliteration":"Sūrya Namaskāra B","level":"Beginner","category":"Transition","tags":["vinyasa","warmup"],"image":"","notes":""},
      {"english":"Big Toe Pose","sanskrit":"पादाङ्गुष्ठासन","transliteration":"Pādaṅguṣṭhāsana","level":"Beginner","category":"Standing","tags":["hamstrings"],"image":"","notes":""},
      {"english":"Hand to Foot Pose","sanskrit":"पादहस्तासन","transliteration":"Pāda Hastāsana","level":"Beginner","category":"Standing","tags":["hamstrings"],"image":"","notes":""},
      {"english":"Extended Triangle Pose","sanskrit":"उत्त्थित त्रिकोणासन","transliteration":"Utthita Trikoṇāsana","level":"Beginner","category":"Standing","tags":["lateral"],"image":"","notes":""},
      {"english":"Revolved Triangle Pose","sanskrit":"परिवृत्त त्रिकोणासन","transliteration":"Parivṛtta Trikoṇāsana","level":"Intermediate","category":"Standing","tags":["twist"],"image":"","notes":""},
      {"english":"Extended Side Angle Pose","sanskrit":"उत्त्थित पार्श्वकोणासन","transliteration":"Utthita Pārśvakoṇāsana","level":"Beginner","category":"Standing","tags":["lateral"],"image":"","notes":""},
      {"english":"Revolved Side Angle Pose","sanskrit":"परिवृत्त पार्श्वकोणासन","transliteration":"Parivṛtta Pārśvakoṇāsana","level":"Intermediate","category":"Standing","tags":["twist"],"image":"","notes":""},
      {"english":"Wide-Legged Forward Fold A","sanskrit":"प्रसारित पादोत्तानासन A","transliteration":"Prasārita Padottānāsana A","level":"Beginner","category":"Standing","tags":["hamstrings"],"image":"","notes":""},
      {"english":"Wide-Legged Forward Fold B","sanskrit":"प्रसारित पादोत्तानासन B","transliteration":"Prasārita Padottānāsana B","level":"Beginner","category":"Standing","tags":["hamstrings"],"image":"","notes":""},
      {"english":"Wide-Legged Forward Fold C","sanskrit":"प्रसारित पादोत्तानासन C","transliteration":"Prasārita Padottānāsana C","level":"Beginner","category":"Standing","tags":["shoulders"],"image":"","notes":""},
      {"english":"Wide-Legged Forward Fold D","sanskrit":"प्रसारित पादोत्तानासन D","transliteration":"Prasārita Padottānāsana D","level":"Beginner","category":"Standing","tags":["hamstrings"],"image":"","notes":""},
      {"english":"Intense Side Stretch","sanskrit":"पार्श्वोत्तानासन","transliteration":"Pārśvottānāsana","level":"Intermediate","category":"Standing","tags":["hamstrings"],"image":"","notes":""},
      {"english":"Extended Hand-to-Big-Toe","sanskrit":"उत्त्थित हस्त पादाङ्गुष्ठासन","transliteration":"Utthita Hasta Pādāṅguṣṭhāsana","level":"Intermediate","category":"Standing","tags":["balance"],"image":"","notes":""},
      {"english":"Half Bound Lotus Standing Fold","sanskrit":"अर्ध बद्ध पद्मोत्तानासन","transliteration":"Ardha Baddha Padmottānāsana","level":"Intermediate","category":"Standing","tags":["balance","hip"],"image":"","notes":""},
      {"english":"Chair Pose","sanskrit":"उत्कटासन","transliteration":"Utkatāsana","level":"Beginner","category":"Standing","tags":["legs"],"image":"","notes":""},
      {"english":"Warrior I","sanskrit":"वीरभद्रासन A","transliteration":"Vīrabhadrāsana A","level":"Beginner","category":"Standing","tags":["legs","hip"],"image":"","notes":""},
      {"english":"Warrior II","sanskrit":"वीरभद्रासन B","transliteration":"Vīrabhadrāsana B","level":"Beginner","category":"Standing","tags":["legs"],"image":"","notes":""},
      {"english":"Staff Pose","sanskrit":"दण्डासन","transliteration":"Daṇḍāsana","level":"Beginner","category":"Seated","tags":["foundation"],"image":"","notes":""},
      {"english":"Seated Forward Fold A","sanskrit":"पश्चिमोत्तानासन A","transliteration":"Paścimottānāsana A","level":"Beginner","category":"Forward Bend","tags":["hamstrings"],"image":"","notes":""},
      {"english":"Seated Forward Fold B","sanskrit":"पश्चिमोत्तानासन B","transliteration":"Paścimottānāsana B","level":"Beginner","category":"Forward Bend","tags":["hamstrings"],"image":"","notes":""},
      {"english":"Seated Forward Fold C","sanskrit":"पश्चिमोत्तानासन C","transliteration":"Paścimottānāsana C","level":"Beginner","category":"Forward Bend","tags":["hamstrings"],"image":"","notes":""},
      {"english":"Upward Plank Pose","sanskrit":"पूर्वोत्तानासन","transliteration":"Pūrvottānāsana","level":"Intermediate","category":"Backbend","tags":["shoulders","front-body"],"image":"","notes":""},
      {"english":"Half Bound Lotus Seated Fold","sanskrit":"अर्ध बद्ध पद्म पश्चिमोत्तानासन","transliteration":"Ardha Baddha Padma Paścimottānāsana","level":"Intermediate","category":"Forward Bend","tags":["hip"],"image":"","notes":""},
      {"english":"Three-Limbed Seated Forward Fold","sanskrit":"त्र्यङ्ग मुख एक पाद पश्चिमोत्तानासन","transliteration":"Triāṅga Mukha Eka Pāda Paścimottānāsana","level":"Beginner","category":"Forward Bend","tags":["hamstrings"],"image":"","notes":""},
      {"english":"Head-to-Knee A","sanskrit":"जानु शीर्षासन A","transliteration":"Jānu Śīrṣāsana A","level":"Beginner","category":"Forward Bend","tags":["hamstrings"],"image":"","notes":""},
      {"english":"Head-to-Knee B","sanskrit":"जानु शीर्षासन B","transliteration":"Jānu Śīrṣāsana B","level":"Intermediate","category":"Forward Bend","tags":[],"image":"","notes":""},
      {"english":"Head-to-Knee C","sanskrit":"जानु शीर्षासन C","transliteration":"Jānu Śīrṣāsana C","level":"Intermediate","category":"Forward Bend","tags":[],"image":"","notes":""},
      {"english":"Marichi’s Pose A","sanskrit":"मारीच्यासन A","transliteration":"Marīcyāsana A","level":"Intermediate","category":"Seated","tags":["twist","bind"],"image":"","notes":""},
      {"english":"Marichi’s Pose B","sanskrit":"मारीच्यासन B","transliteration":"Marīcyāsana B","level":"Intermediate","category":"Seated","tags":["bind","lotus"],"image":"","notes":""},
      {"english":"Marichi’s Pose C","sanskrit":"मारीच्यासन C","transliteration":"Marīcyāsana C","level":"Intermediate","category":"Seated","tags":["twist"],"image":"","notes":""},
      {"english":"Marichi’s Pose D","sanskrit":"मारीच्यासन D","transliteration":"Marīcyāsana D","level":"Advanced","category":"Seated","tags":["twist","bind","lotus"],"image":"","notes":""},
      {"english":"Boat Pose","sanskrit":"नावासन","transliteration":"Nāvāsana","level":"Beginner","category":"Core","tags":["core"],"image":"","notes":""},
      {"english":"Shoulder-Pressing Pose","sanskrit":"भुजपीडासन","transliteration":"Bhujapīḍāsana","level":"Intermediate","category":"Arm Balance","tags":["arm-balance"],"image":"","notes":""},
      {"english":"Tortoise Pose","sanskrit":"कूर्मासन","transliteration":"Kūrmāsana","level":"Intermediate","category":"Forward Bend","tags":["hip","fold"],"image":"","notes":""},
      {"english":"Sleeping Tortoise","sanskrit":"सुप्त कूर्मासन","transliteration":"Supta Kūrmāsana","level":"Advanced","category":"Forward Bend","tags":["hip","fold"],"image":"","notes":""},
      {"english":"Embryo Pose","sanskrit":"गर्भ पिण्डासन","transliteration":"Garbha Piṇḍāsana","level":"Intermediate","category":"Arm Balance","tags":["bind","balance"],"image":"","notes":""},
      {"english":"Rooster Pose","sanskrit":"कुक्कुटासन","transliteration":"Kukkuṭāsana","level":"Intermediate","category":"Arm Balance","tags":["lotus","arm-balance"],"image":"","notes":""},
      {"english":"Bound Angle Pose","sanskrit":"बद्ध कोणासन","transliteration":"Baddha Koṇāsana","level":"Beginner","category":"Hip Opener","tags":["hip"],"image":"","notes":""},
      {"english":"Wide-Angle Seated Fold A","sanskrit":"उपविष्ट कोणासन A","transliteration":"Upaviṣṭha Koṇāsana A","level":"Beginner","category":"Forward Bend","tags":["hamstrings"],"image":"","notes":""},
      {"english":"Wide-Angle Seated Fold B","sanskrit":"उपविष्ट कोणासन B","transliteration":"Upaviṣṭha Koṇāsana B","level":"Beginner","category":"Forward Bend","tags":["hamstrings"],"image":"","notes":""},
      {"english":"Supine Angle Pose","sanskrit":"सुप्त कोणासन","transliteration":"Supta Koṇāsana","level":"Intermediate","category":"Inversion","tags":["core"],"image":"","notes":""},
      {"english":"Supine Hand-to-Big-Toe","sanskrit":"सुप्त पादाङ्गुष्ठासन","transliteration":"Supta Pādāṅguṣṭhāsana","level":"Beginner","category":"Supine","tags":["hamstrings"],"image":"","notes":""},
      {"english":"Both Big Toes Pose","sanskrit":"उभय पादाङ्गुष्ठासन","transliteration":"Ubhaya Pādāṅguṣṭhāsana","level":"Intermediate","category":"Core","tags":["balance"],"image":"","notes":""},
      {"english":"Up-Face Intense Stretch","sanskrit":"ऊर्ध्वमुख पश्चिमोत्तानासन","transliteration":"Ūrdhva Mukha Paścimottānāsana","level":"Intermediate","category":"Core","tags":["balance","fold"],"image":"","notes":""},
      {"english":"Bridge Lock Pose","sanskrit":"सेतुबन्ध सर्वाङ्गासन","transliteration":"Setu Bandha Sarvāṅgāsana","level":"Advanced","category":"Backbend","tags":["backbend"],"image":"","notes":""},
      {"english":"Upward Bow (Wheel)","sanskrit":"ऊर्ध्व धनुरासन","transliteration":"Ūrdhva Dhanurāsana","level":"Intermediate","category":"Backbend","tags":["backbend"],"image":"","notes":""},
      {"english":"Supported Shoulderstand","sanskrit":"सालम्ब सर्वाङ्गासन","transliteration":"Sālamba Sarvāṅgāsana","level":"Beginner","category":"Inversion","tags":["inversion"],"image":"","notes":""},
      {"english":"Plow Pose","sanskrit":"हलासन","transliteration":"Halāsana","level":"Beginner","category":"Inversion","tags":["inversion"],"image":"","notes":""},
      {"english":"Ear Pressure Pose","sanskrit":"कर्णपीडासन","transliteration":"Karṇapīḍāsana","level":"Intermediate","category":"Inversion","tags":["inversion"],"image":"","notes":""},
      {"english":"Fish Pose","sanskrit":"मत्स्यासन","transliteration":"Matsyāsana","level":"Beginner","category":"Backbend","tags":["chest"],"image":"","notes":""},
      {"english":"Extended Legs Pose","sanskrit":"उत्तान पादासन","transliteration":"Uttāna Pādāsana","level":"Beginner","category":"Core","tags":["core"],"image":"","notes":""},
      {"english":"Bound Lotus","sanskrit":"बद्ध पद्मासन","transliteration":"Baddha Padmāsana","level":"Intermediate","category":"Seated","tags":["lotus"],"image":"","notes":""},
      {"english":"Yoga Seal","sanskrit":"योग मुद्रा","transliteration":"Yoga Mudrā","level":"Intermediate","category":"Seated","tags":["mudra"],"image":"","notes":""},
      {"english":"Lotus Pose","sanskrit":"पद्मासन","transliteration":"Padmāsana","level":"Intermediate","category":"Seated","tags":["lotus"],"image":"","notes":""},
      {"english":"Corpse Pose","sanskrit":"शवासन","transliteration":"Śavāsana","level":"Beginner","category":"Closing","tags":["relaxation"],"image":"","notes":""},
      {"english":"Noose Pose","sanskrit":"पाशासन","transliteration":"Pāśāsana","level":"Intermediate","category":"Twist","tags":["bind","squat"],"image":"","notes":""},
      {"english":"Heron Pose","sanskrit":"क्रौञ्चासन","transliteration":"Krauñchāsana","level":"Intermediate","category":"Seated","tags":["hamstrings"],"image":"","notes":""},
      {"english":"Locust Pose","sanskrit":"शलभासन","transliteration":"Śalabhāsana","level":"Beginner","category":"Backbend","tags":["back"],"image":"","notes":""},
      {"english":"Frog Pose","sanskrit":"भेकासन","transliteration":"Bhekāsana","level":"Intermediate","category":"Backbend","tags":["quads","chest"],"image":"","notes":""},
      {"english":"Bow Pose","sanskrit":"धनुरासन","transliteration":"Dhanurāsana","level":"Beginner","category":"Backbend","tags":["back"],"image":"","notes":""},
      {"english":"Gate Pose","sanskrit":"परिघासन","transliteration":"Parighāsana","level":"Beginner","category":"Kneeling","tags":["lateral"],"image":"","notes":""},
      {"english":"Camel Pose","sanskrit":"उष्ट्रासन","transliteration":"Uṣṭrāsana","level":"Beginner","category":"Backbend","tags":["chest","hip"],"image":"","notes":""},
      {"english":"Little Thunderbolt","sanskrit":"लघु वज्रासन","transliteration":"Laghu Vajrāsana","level":"Advanced","category":"Backbend","tags":["backbend"],"image":"","notes":""},
      {"english":"Pigeon (Deep Backbend)","sanskrit":"कपोतासन","transliteration":"Kapotāsana","level":"Advanced","category":"Backbend","tags":["deep-backbend"],"image":"","notes":""},
      {"english":"Reclined Thunderbolt","sanskrit":"सुप्त वज्रासन","transliteration":"Supta Vajrāsana","level":"Intermediate","category":"Backbend","tags":["backbend"],"image":"","notes":""},
      {"english":"One-Leg Behind Head","sanskrit":"एक पाद शीर्षासन","transliteration":"Eka Pāda Śīrṣāsana","level":"Advanced","category":"Hip Opener","tags":["behind-head"],"image":"","notes":""},
      {"english":"Both-Legs Behind Head","sanskrit":"द्विपाद शीर्षासन","transliteration":"Dvipāda Śīrṣāsana","level":"Advanced","category":"Hip Opener","tags":["behind-head"],"image":"","notes":""},
      {"english":"Yogic Sleep Pose","sanskrit":"योग निद्रासन","transliteration":"Yoga Nidrāsana","level":"Advanced","category":"Hip Opener","tags":["behind-head"],"image":"","notes":""},
      {"english":"Firefly Pose","sanskrit":"टिट्टिभासन","transliteration":"Tittibhāsana","level":"Intermediate","category":"Arm Balance","tags":["arm-balance"],"image":"","notes":""},
      {"english":"Forearm Stand","sanskrit":"पिञ्च मयूरासन","transliteration":"Piñcha Mayūrāsana","level":"Intermediate","category":"Inversion","tags":["inversion","balance"],"image":"","notes":""},
      {"english":"Karandavasana","sanskrit":"करण्डवासन","transliteration":"Karaṇḍavāsana","level":"Advanced","category":"Inversion","tags":["strength"],"image":"","notes":""},
      {"english":"Peacock Pose","sanskrit":"मयूरासन","transliteration":"Mayūrāsana","level":"Advanced","category":"Arm Balance","tags":["arm-balance","strength"],"image":"","notes":""},
      {"english":"Crocodile Jumps","sanskrit":"नक्रासन","transliteration":"Nakrasana","level":"Advanced","category":"Arm Balance","tags":["dynamic"],"image":"","notes":""},
      {"english":"Vatayanasana","sanskrit":"वातयानासन","transliteration":"Vātayānāsana","level":"Intermediate","category":"Seated","tags":["hip","twist"],"image":"","notes":""},
      {"english":"Gomukhasana","sanskrit":"गोमुखासन","transliteration":"Gomukhāsana","level":"Intermediate","category":"Seated","tags":["shoulders","hips"],"image":"","notes":""},
      {"english":"Side Plank Pose","sanskrit":"वसिष्ठासन","transliteration":"Vasiṣṭhāsana","level":"Intermediate","category":"Arm Balance","tags":["balance","strength"],"image":"","notes":""},
      {"english":"Sage Viśvāmitra Pose","sanskrit":"विश्वामित्रासन","transliteration":"Viśvāmitrāsana","level":"Advanced","category":"Arm Balance","tags":["hamstrings","twist"],"image":"","notes":""},
      {"english":"Sage Kaśyapa Pose","sanskrit":"कश्यपासन","transliteration":"Kaśyapāsana","level":"Advanced","category":"Arm Balance","tags":["twist","bind"],"image":"","notes":""},
      {"english":"Cakorāsana","sanskrit":"चकौरासन","transliteration":"Cakorāsana","level":"Advanced","category":"Arm Balance","tags":[],"image":"","notes":""},
      {"english":"Bhairavāsana","sanskrit":"भैरवासन","transliteration":"Bhairavāsana","level":"Advanced","category":"Arm Balance","tags":[],"image":"","notes":""},
      {"english":"Skandāsana (advanced variant)","sanskrit":"स्कन्दासन","transliteration":"Skandāsana","level":"Advanced","category":"Arm Balance","tags":[],"image":"","notes":""},
      {"english":"Durvāsana","sanskrit":"दुर्वासन","transliteration":"Durvāsana","level":"Advanced","category":"Arm Balance","tags":["leg-behind-head"],"image":"","notes":""},
      {"english":"Upward Rooster A","sanskrit":"ऊर्ध्व कुक्कुटासन A","transliteration":"Ūrdhva Kukkuṭāsana A","level":"Advanced","category":"Arm Balance","tags":[],"image":"","notes":""},
      {"english":"Upward Rooster B","sanskrit":"ऊर्ध्व कुक्कुटासन B","transliteration":"Ūrdhva Kukkuṭāsana B","level":"Advanced","category":"Arm Balance","tags":[],"image":"","notes":""},
      {"english":"Upward Rooster C","sanskrit":"ऊर्ध्व कुक्कुटासन C","transliteration":"Ūrdhva Kukkuṭāsana C","level":"Advanced","category":"Arm Balance","tags":[],"image":"","notes":""},
      {"english":"Flying Pigeon Pose","sanskrit":"गलवासन","transliteration":"Gālavāsana","level":"Advanced","category":"Arm Balance","tags":["hip","balance"],"image":"","notes":""},
      {"english":"One-Legged Crane A","sanskrit":"एक पाद बकासन A","transliteration":"Eka Pāda Bakāsana A","level":"Advanced","category":"Arm Balance","tags":["arm-balance"],"image":"","notes":""},
      {"english":"One-Legged Crane B","sanskrit":"एक पाद बकासन B","transliteration":"Eka Pāda Bakāsana B","level":"Advanced","category":"Arm Balance","tags":["arm-balance"],"image":"","notes":""},
      {"english":"Sage Koundinya A","sanskrit":"कौण्डिन्यासन A","transliteration":"Kauṇḍinyāsana A","level":"Advanced","category":"Arm Balance","tags":["arm-balance"],"image":"","notes":""},
      {"english":"Sage Koundinya B","sanskrit":"कौण्डिन्यासन B","transliteration":"Kauṇḍinyāsana B","level":"Advanced","category":"Arm Balance","tags":["arm-balance"],"image":"","notes":""},
      {"english":"Eight-Angle Pose","sanskrit":"अष्टावक्रासन","transliteration":"Aṣṭāvakrāsana","level":"Advanced","category":"Arm Balance","tags":["arm-balance"],"image":"","notes":""},
      {"english":"Full Lord of the Fishes","sanskrit":"पूर्ण मत्स्येन्द्रासन","transliteration":"Pūrṇa Matsyendrāsana","level":"Advanced","category":"Twist","tags":["deep-twist"],"image":"","notes":""},
      {"english":"Virāñchi’s Pose A1","sanskrit":"वीराञ्च्यासन A1","transliteration":"Vīrāñchyāsana A1","level":"Advanced","category":"Seated","tags":[],"image":"","notes":""},
      {"english":"Virāñchi’s Pose A2","sanskrit":"वीराञ्च्यासन A2","transliteration":"Vīrāñchyāsana A2","level":"Advanced","category":"Seated","tags":[],"image":"","notes":""},
      {"english":"Virāñchi’s Pose A3","sanskrit":"वीराञ्च्यासन A3","transliteration":"Vīrāñchyāsana A3","level":"Advanced","category":"Seated","tags":[],"image":"","notes":""},
      {"english":"Virāñchi’s Pose B1","sanskrit":"वीराञ्च्यासन B1","transliteration":"Vīrāñchyāsana B1","level":"Advanced","category":"Seated","tags":[],"image":"","notes":""},
      {"english":"Virāñchi’s Pose B2","sanskrit":"वीराञ्च्यासन B2","transliteration":"Vīrāñchyāsana B2","level":"Advanced","category":"Seated","tags":[],"image":"","notes":""},
      {"english":"Virāñchi’s Pose B3","sanskrit":"वीराञ्च्यासन B3","transliteration":"Vīrāñchyāsana B3","level":"Advanced","category":"Seated","tags":[],"image":"","notes":""},
      {"english":"Two-Legged Inverted Staff","sanskrit":"द्विपाद विपरीत दण्डासन","transliteration":"Dvīpāda Viparīta Daṇḍāsana","level":"Advanced","category":"Backbend","tags":["inversion","backbend"],"image":"","notes":""},
      {"english":"One-Legged Inverted Staff","sanskrit":"एक पाद विपरीत दण्डासन","transliteration":"Eka Pāda Viparīta Daṇḍāsana","level":"Advanced","category":"Backbend","tags":["inversion","backbend"],"image":"","notes":""},
      {"english":"Inverted Locust","sanskrit":"विपरीत शलभासन","transliteration":"Viparīta Śalabhāsana","level":"Advanced","category":"Backbend","tags":["backbend"],"image":"","notes":""},
      {"english":"Formidable Face Pose","sanskrit":"गण्ड भेरुण्डासन","transliteration":"Gaṇḍa Bheruṇḍāsana","level":"Advanced","category":"Backbend","tags":["deep-backbend"],"image":"","notes":""},
      {"english":"Hanuman Splits A","sanskrit":"हनुमानासन A","transliteration":"Hanumānāsana A","level":"Advanced","category":"Hip Opener","tags":["splits"],"image":"","notes":""},
      {"english":"Hanuman Splits B","sanskrit":"हनुमानासन B","transliteration":"Hanumānāsana B","level":"Advanced","category":"Hip Opener","tags":["splits"],"image":"","notes":""},
      {"english":"Reclined Overhead Splits","sanskrit":"सुप्त त्रिविक्रमासन","transliteration":"Supta Trivikramāsana","level":"Advanced","category":"Hip Opener","tags":[],"image":"","notes":""},
      {"english":"Dīkāsana A","sanskrit":"दीकासन A","transliteration":"Dīkāsana A","level":"Advanced","category":"Standing","tags":[],"image":"","notes":""},
      {"english":"Dīkāsana B","sanskrit":"दीकासन B","transliteration":"Dīkāsana B","level":"Advanced","category":"Standing","tags":[],"image":"","notes":""},
      {"english":"Standing Trivikrama","sanskrit":"उत्त्थित त्रिविक्रमासन","transliteration":"Utthita Trivikramāsana","level":"Advanced","category":"Standing","tags":[],"image":"","notes":""},
      {"english":"Dancer Pose","sanskrit":"नटराजासन","transliteration":"Naṭarājāsana","level":"Advanced","category":"Backbend","tags":["balance"],"image":"","notes":""},
      {"english":"King Pigeon","sanskrit":"राज कपोतासन","transliteration":"Rāja Kapotāsana","level":"Advanced","category":"Backbend","tags":["deep-backbend"],"image":"","notes":""},
      {"english":"One-Legged King Pigeon","sanskrit":"एक पाद राज कपोतासन","transliteration":"Eka Pāda Rāja Kapotāsana","level":"Advanced","category":"Backbend","tags":["deep-backbend"],"image":"","notes":""},
      {"english":"Mulabandhasana","sanskrit":"मूलबन्धासन","transliteration":"Mulabandhāsana","level":"Advanced","category":"Seated","tags":[],"image":"","notes":""},
      {"english":"Nahusha Pose A","sanskrit":"नहुषासन A","transliteration":"Nahūṣāsana A","level":"Advanced","category":"Arm Balance","tags":[],"image":"","notes":""},
      {"english":"Nahusha Pose B","sanskrit":"नहुषासन B","transliteration":"Nahūṣāsana B","level":"Advanced","category":"Arm Balance","tags":[],"image":"","notes":""},
      {"english":"Nahusha Pose C","sanskrit":"नहुषासन C","transliteration":"Nahūṣāsana C","level":"Advanced","category":"Arm Balance","tags":[],"image":"","notes":""},
      {"english":"Scorpion Pose","sanskrit":"वृश्चिकासन","transliteration":"Vṛścikāsana","level":"Advanced","category":"Inversion","tags":["backbend","inversion"],"image":"","notes":""},
      {"english":"Reclining Pose","sanskrit":"शयनासन","transliteration":"Śayanāsana","level":"Advanced","category":"Backbend","tags":[],"image":"","notes":""},
      {"english":"Buddha Pose","sanskrit":"बुद्धासन","transliteration":"Buddhāsana","level":"Advanced","category":"Seated","tags":[],"image":"","notes":""},
      {"english":"Kapila’s Pose","sanskrit":"कपिलासन","transliteration":"Kapilāsana","level":"Advanced","category":"Seated","tags":[],"image":"","notes":""},
      {"english":"Archer Pose A","sanskrit":"आकर्ण धनुरासन A","transliteration":"Ākarṇa Dhanurāsana A","level":"Advanced","category":"Seated","tags":["hamstrings"],"image":"","notes":""},
      {"english":"Archer Pose B","sanskrit":"आकर्ण धनुरासन B","transliteration":"Ākarṇa Dhanurāsana B","level":"Advanced","category":"Seated","tags":["hamstrings"],"image":"","notes":""},
      {"english":"Big-Toe Bow A","sanskrit":"पादाङ्गुष्ठ धनुरासन A","transliteration":"Pādaṅguṣṭha Dhanurāsana A","level":"Advanced","category":"Backbend","tags":[],"image":"","notes":""},
      {"english":"Big-Toe Bow B","sanskrit":"पादाङ्गुष्ठ धनुरासन B","transliteration":"Pādaṅguṣṭha Dhanurāsana B","level":"Advanced","category":"Backbend","tags":[],"image":"","notes":""},
      {"english":"Marichi’s Pose E","sanskrit":"मारीच्यासन E","transliteration":"Marīcyāsana E","level":"Advanced","category":"Seated","tags":["bind"],"image":"","notes":""},
      {"english":"Marichi’s Pose F","sanskrit":"मारीच्यासन F","transliteration":"Marīcyāsana F","level":"Advanced","category":"Seated","tags":["bind"],"image":"","notes":""},
      {"english":"Marichi’s Pose G","sanskrit":"मारीच्यासन G","transliteration":"Marīcyāsana G","level":"Advanced","category":"Seated","tags":["bind"],"image":"","notes":""},
      {"english":"Marichi’s Pose H","sanskrit":"मारीच्यासन H","transliteration":"Marīcyāsana H","level":"Advanced","category":"Seated","tags":["bind"],"image":"","notes":""},
      {"english":"Mountain (context)","sanskrit":"ताडासन","transliteration":"Tāḍāsana","level":"Beginner","category":"Standing","tags":[],"image":"","notes":""},
      {"english":"Samanasana","sanskrit":"समानासन","transliteration":"Samānāsana","level":"Advanced","category":"Seated","tags":[],"image":"","notes":""},
      {"english":"Side Crane Pose","sanskrit":"पार्श्व बकासन","transliteration":"Pārśva Bakāsana","level":"Advanced","category":"Arm Balance","tags":["arm-balance"],"image":"","notes":""},
      {"english":"One-Legged Rooster","sanskrit":"पुङ्ग कुक्कुटासन","transliteration":"Puṅga Kukkuṭāsana","level":"Advanced","category":"Arm Balance","tags":[],"image":"","notes":""},
      {"english":"One-Legged Bow","sanskrit":"एक पाद धनुरासन","transliteration":"Eka Pāda Dhanurāsana","level":"Advanced","category":"Backbend","tags":[],"image":"","notes":""},
      {"english":"One-Legged Pigeon Backbend","sanskrit":"एक पाद कपोतासन","transliteration":"Eka Pāda Kapotāsana","level":"Advanced","category":"Backbend","tags":[],"image":"","notes":""},
      {"english":"Couch Pose A","sanskrit":"पर्यङ्कासन A","transliteration":"Paryaṅkāsana A","level":"Advanced","category":"Backbend","tags":[],"image":"","notes":""},
      {"english":"Couch Pose B","sanskrit":"पर्यङ्कासन B","transliteration":"Paryaṅkāsana B","level":"Advanced","category":"Backbend","tags":[],"image":"","notes":""},
      {"english":"Womb Staff Pose","sanskrit":"योनि दण्डासन","transliteration":"Yoni Daṇḍāsana","level":"Advanced","category":"Seated","tags":[],"image":"","notes":""},
      {"english":"Arm Staff Pose","sanskrit":"भुजा दण्डासन","transliteration":"Bhujā Daṇḍāsana","level":"Advanced","category":"Arm Balance","tags":[],"image":"","notes":""},
      {"english":"Side Staff Pose","sanskrit":"पार्श्व दण्डासन","transliteration":"Pārśva Daṇḍāsana","level":"Advanced","category":"Seated","tags":[],"image":"","notes":""},
      {"english":"Upward Staff Pose","sanskrit":"ऊर्ध्व दण्डासन","transliteration":"Ūrdhva Daṇḍāsana","level":"Advanced","category":"Inversion","tags":[],"image":"","notes":""},
      {"english":"Downward Staff Pose","sanskrit":"अधो दण्डासन","transliteration":"Adho Daṇḍāsana","level":"Advanced","category":"Inversion","tags":[],"image":"","notes":""},
      {"english":"Right-Angle Splits","sanskrit":"समकोणासन","transliteration":"Samakonāsana","level":"Advanced","category":"Hip Opener","tags":[],"image":"","notes":""},
      {"english":"Om Pose","sanskrit":"ओंकारासन","transliteration":"Oṃkārāsana","level":"Advanced","category":"Closing","tags":[],"image":"","notes":""}
    ];

    function renderPostures() {
      AppRoot.innerHTML = `
        <section class="grid" aria-label="Postures">
          <div id="postureFilters" class="posture-filters" role="search" style="${isPostureOpen ? 'display:none;' : ''}">
            <div class="row">
              <input id="poseSearch" class="input" placeholder="Search English, Sanskrit, transliteration, tags" aria-label="Search postures" />
              <select id="poseCategory" class="input" aria-label="Filter by category">
                <option value="">All categories</option>
                <option>Standing</option>
                <option>Seated</option>
                <option>Backbend</option>
                <option>Twist</option>
                <option>Inversion</option>
                <option>Arm Balance</option>
                <option>Hip Opener</option>
                <option>Forward Bend</option>
                <option>Closing</option>
                <option>Transition</option>
                <option>Core</option>
                <option>Supine</option>
                <option>Kneeling</option>
              </select>
              <select id="poseLevel" class="input" aria-label="Filter by level" style="max-width:160px;">
                <option value="">All levels</option>
                <option>Beginner</option>
                <option>Intermediate</option>
                <option>Advanced</option>
              </select>
            </div>
          </div>
          <div id="p-grid" class="posture-grid" role="list"></div>
        </section>
        <div id="p-modal" class="modal" aria-hidden="true" aria-label="Posture details" role="dialog">
          <div class="modal-card" role="document">
            <div class="row" style="justify-content:space-between;">
              <strong id="pm-title"></strong>
              <button class="btn sm ghost" id="pm-close" aria-label="Close">Close</button>
            </div>
            <div id="pm-body"></div>
          </div>
        </div>
      `;

      const search = document.getElementById('poseSearch');
      const cat = document.getElementById('poseCategory');
      const lvl = document.getElementById('poseLevel');
      const grid = document.getElementById('p-grid');
      const modal = document.getElementById('p-modal');
      const pmTitle = document.getElementById('pm-title');
      const pmBody = document.getElementById('pm-body');
      document.getElementById('pm-close').addEventListener('click', closeModal);
      document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeModal(); });

      // Build search index
      function buildPoseIndex(poses){
        POSE_INDEX = poses.map(p=>({
          ref:p,
          nEnglish: normalize(p.english),
          nSanskrit: normalize(p.sanskrit),
          nTrans: normalize(p.transliteration),
          nTags: normalize((p.tags||[]).join(' '))
        }));
      }
      buildPoseIndex(POSES);

      function levelClass(level) {
        const l = (level||'').toLowerCase();
        if (l.startsWith('begin')) return 'level level-beginner';
        if (l.startsWith('inter')) return 'level level-intermediate';
        return 'level level-advanced';
      }
      function draw() {
        const q = normalize(search.value || '');
        const c = (cat.value || '').toLowerCase();
        const l = (lvl.value || '').toLowerCase();
        const fromIndex = POSE_INDEX.filter(row => {
          const matchesQ = !q || row.nEnglish.includes(q) || row.nSanskrit.includes(q) || row.nTrans.includes(q) || row.nTags.includes(q);
          if (!matchesQ) return false;
          const p = row.ref;
          const matchesC = !c || (p.category||'').toLowerCase() === c;
          const matchesL = !l || (p.level||'').toLowerCase().startsWith(l);
          return matchesC && matchesL;
        }).map(row => row.ref);
        const items = fromIndex;
        grid.innerHTML = items.map((p, idx) => `
          <button class="posture-card" role="button" aria-label="Open posture ${p.english}" data-idx="${idx}">
            <div class="posture-media" aria-hidden="true">🧘</div>
            <div class="posture-body">
              <div class="row" style="justify-content:space-between; align-items:center;">
                <strong>${p.english}</strong>
                <span class="${levelClass(p.level)}">${p.level}</span>
              </div>
              <div class="devanagari">${p.sanskrit || ''}</div>
              <div class="translit">${p.transliteration || ''}</div>
            </div>
          </button>
        `).join('');
        grid.querySelectorAll('.posture-card').forEach(card => {
          card.addEventListener('click', () => openModal(items[parseInt(card.getAttribute('data-idx'),10)]));
          card.addEventListener('keydown', (e) => { if (e.key === 'Enter') openModal(items[parseInt(card.getAttribute('data-idx'),10)]); });
        });
      }
      function openModal(p) {
        const filters = document.getElementById('postureFilters');
        if (filters) filters.style.display = 'none';
        isPostureOpen = true;
        pmTitle.textContent = p.english;
        const hasGuide = !!p.guide;
        pmBody.innerHTML = `
          <div class="row" style="gap:12px; align-items:flex-start;">
            <div class="posture-media" style="width:140px; height:140px;">🧘</div>
            <div style="flex:1;">
              <div class="devanagari">${p.sanskrit || ''}</div>
              <div class="translit">${p.transliteration || ''}</div>
              <div class="small" style="margin-top:6px;">Category: ${p.category || ''}</div>
              <div class="row" style="margin-top:6px;">${(p.tags||[]).map(tg => `<span class='chip'>${tg}</span>`).join(' ')}</div>
              <div class="muted" style="margin-top:8px;">${p.notes || ''}</div>
            </div>
          </div>
          <div class="row" style="justify-content:flex-end; margin-top:10px;">
            <button class="btn ${hasGuide? '': 'ghost'}" ${hasGuide? '': 'disabled'} aria-label="Guide me">Guide me</button>
          </div>
        `;
        modal.setAttribute('open',''); modal.setAttribute('aria-hidden','false');
      }
      function closeModal(){ modal.removeAttribute('open'); modal.setAttribute('aria-hidden','true'); const filters = document.getElementById('postureFilters'); if (filters) filters.style.display = ''; isPostureOpen = false; }

      search.addEventListener('input', draw);
      cat.addEventListener('change', draw);
      lvl.addEventListener('change', draw);
      draw();
      AppRoot.focus();
    }

    // Kickoff
    init();
    render();
  </script>
</body>
</html>


